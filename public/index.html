<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
    <title>Vertragsmanagement</title>
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="default">
    <link rel="icon" id="favicon" href="data:,">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=DM+Sans:ital,opsz,wght@0,9..40,300;0,9..40,400;0,9..40,500;0,9..40,600;0,9..40,700;1,9..40,400&display=swap" rel="stylesheet">
    <style>
        *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }

        :root {
            --bg:            #f5f5f7;
            --bg-card:       #ffffff;
            --bg-elevated:   #f0f0f2;
            --text:          #1d1d1f;
            --text-2:        #6e6e73;
            --text-3:        #aeaeb2;
            --accent:        #007aff;
            --accent-h:      #0056cc;
            --danger:        #ff3b30;
            --success:       #34c759;
            --warning:       #ff9f0a;
            --border:        rgba(0,0,0,0.07);
            --shadow-sm:     0 2px 8px rgba(0,0,0,0.05);
            --shadow-md:     0 4px 20px rgba(0,0,0,0.07), 0 1px 3px rgba(0,0,0,0.04);
            --shadow-lg:     0 12px 40px rgba(0,0,0,0.09), 0 4px 12px rgba(0,0,0,0.05);
            --r-sm: 10px; --r-md: 14px; --r-lg: 20px;
            --nav-bg:        rgba(245,245,247,.85);
            --ghost-hover:   rgba(0,0,0,.05);
            --accent-soft:   rgba(0,122,255,.06);
            --danger-bg:     rgba(255,59,48,.08);
            --danger-border: rgba(255,59,48,.15);
            --danger-hover:  rgba(255,59,48,.14);
            --accent-badge:  rgba(0,122,255,.12);
            --accent-glow:   rgba(0,122,255,.3);
            --toast-bg:      #1c1c1e;
        }

        [data-theme="dark"] {
            --bg:            #212126;
            --bg-card:       #2c2c34;
            --bg-elevated:   #3a3a42;
            --text:          #f0f0f5;
            --text-2:        #c5c5cc;
            --text-3:        #8e8e99;
            --accent:        #3a9eff;
            --accent-h:      #6ab6ff;
            --danger:        #ff6961;
            --success:       #4ade80;
            --warning:       #ffb84d;
            --border:        rgba(255,255,255,0.14);
            --shadow-sm:     0 2px 8px rgba(0,0,0,0.3);
            --shadow-md:     0 4px 20px rgba(0,0,0,0.4), 0 1px 3px rgba(0,0,0,0.2);
            --shadow-lg:     0 12px 40px rgba(0,0,0,0.5), 0 4px 12px rgba(0,0,0,0.3);
            --nav-bg:        rgba(33,33,38,.88);
            --ghost-hover:   rgba(255,255,255,.1);
            --accent-soft:   rgba(58,158,255,.15);
            --danger-bg:     rgba(255,105,97,.15);
            --danger-border: rgba(255,105,97,.25);
            --danger-hover:  rgba(255,105,97,.25);
            --accent-badge:  rgba(58,158,255,.22);
            --accent-glow:   rgba(58,158,255,.4);
            --toast-bg:      #f0f0f5;
        }

        @media (hover: hover) and (min-width: 768px) {
            [data-theme="dark"] {
                --bg:            #28282e;
                --bg-card:       #343440;
                --bg-elevated:   #42424c;
                --text-3:        #9a9aa6;
                --border:        rgba(255,255,255,0.16);
                --nav-bg:        rgba(40,40,46,.9);
            }
        }

        body {
            font-family: 'DM Sans', -apple-system, BlinkMacSystemFont, 'SF Pro Display', system-ui, sans-serif;
            -webkit-font-smoothing: antialiased;
            background: var(--bg);
            color: var(--text);
            line-height: 1.5;
        }

        /* -- Layout -- */
        .max-w { max-width: 960px; margin: 0 auto; padding: 0 16px; }
        .page  { min-height: 100dvh; padding: 16px 0 32px; }

        /* -- Cards -- */
        .card {
            background: var(--bg-card);
            border-radius: var(--r-lg);
            box-shadow: var(--shadow-md);
            border: 1px solid var(--border);
        }
        .card-body { padding: 20px; }

        /* -- Inputs -- */
        input[type="text"], input[type="password"], input[type="number"], input[type="date"], textarea, select {
            font-family: inherit; font-size: 15px; color: var(--text);
            background: var(--bg-elevated); border: 1.5px solid var(--border);
            border-radius: var(--r-sm); padding: 12px 14px; width: 100%;
            transition: border-color .18s, box-shadow .18s; resize: none;
            -webkit-appearance: none; appearance: none;
        }
        input[type="text"]:focus, input[type="password"]:focus, input[type="number"]:focus,
        input[type="date"]:focus, textarea:focus, select:focus {
            outline: none; border-color: var(--accent); background: var(--bg-card);
            box-shadow: 0 0 0 3px var(--accent-badge);
        }
        input::placeholder, textarea::placeholder { color: var(--text-3); }

        /* -- Password field with toggle -- */
        .pw-field { position: relative; }
        .pw-field input { padding-right: 44px; }
        .pw-toggle {
            position: absolute; right: 8px; top: 50%; transform: translateY(-50%);
            background: none; border: none; color: var(--text-3); padding: 6px;
            cursor: pointer; display: flex; align-items: center; justify-content: center;
        }
        .pw-toggle:hover { color: var(--text-2); }
        .pw-toggle:active { transform: translateY(-50%) scale(0.95); }

        /* -- Buttons -- */
        button { font-family: inherit; color: inherit; cursor: pointer; border: none; background: none;
                 transition: all .18s cubic-bezier(.25,.1,.25,1); }
        button:active { transform: scale(0.97); }

        .btn { display: inline-flex; align-items: center; justify-content: center;
               gap: 6px; font-weight: 600; border-radius: var(--r-md); padding: 12px 20px;
               font-size: 15px; white-space: nowrap; }
        .btn-primary   { background: var(--accent); color: #fff; }
        .btn-primary:hover { background: var(--accent-h); box-shadow: 0 4px 14px var(--accent-glow); }
        .btn-secondary { background: var(--bg); color: var(--text); border: 1.5px solid var(--border); }
        .btn-secondary:hover { border-color: var(--accent); color: var(--accent); }
        .btn-danger    { background: var(--danger-bg); color: var(--danger); border: 1.5px solid var(--danger-border); }
        .btn-danger:hover { background: var(--danger-hover); }
        .btn-ghost     { color: var(--text-2); padding: 8px; border-radius: 50%; }
        .btn-ghost:hover { background: var(--ghost-hover); }
        .btn-full      { width: 100%; }
        .btn-sm        { padding: 8px 14px; font-size: 13px; border-radius: var(--r-sm); }

        /* -- Nav -- */
        .nav {
            position: sticky; top: 0; z-index: 50;
            background: var(--nav-bg);
            backdrop-filter: saturate(180%) blur(20px);
            -webkit-backdrop-filter: saturate(180%) blur(20px);
            border-bottom: 1px solid var(--border);
            padding: 12px 16px;
        }
        .nav-inner { max-width: 960px; margin: 0 auto;
                     display: flex; align-items: center; justify-content: space-between; }
        .nav-left { display: flex; align-items: center; gap: 10px; }
        .nav-meta { display: flex; align-items: center; gap: 6px; }
        .nav-date-mobile { display: none; }
        .nav-date-desktop { }
        .nav-title { font-weight: 700; font-size: 17px; letter-spacing: -.02em; }

        /* -- Badge -- */
        .env-badge {
            font-size: 10px; font-weight: 700; letter-spacing: .06em;
            padding: 3px 8px; border-radius: 6px; text-transform: uppercase;
        }
        .badge-development { background: var(--accent-badge); color: var(--accent); }
        .badge-test        { background: rgba(255,159,10,.12); color: var(--warning); }
        .badge-production  { background: rgba(52,199,89,.12);  color: var(--success); }

        /* -- Toast -- */
        .toast-container { position: fixed; bottom: 28px; left: 50%; transform: translateX(-50%); z-index: 200; display: flex; flex-direction: column; gap: 8px; align-items: center; }
        .toast {
            padding: 11px 20px; border-radius: 100px; font-size: 14px; font-weight: 500;
            box-shadow: var(--shadow-lg); white-space: nowrap;
            animation: toastIn .25s ease;
        }
        .toast-success { background: var(--toast-bg); color: var(--bg); }
        .toast-error   { background: var(--danger); color: #fff; }
        @keyframes toastIn { from { opacity:0; transform: translateY(10px); }
                             to   { opacity:1; transform: translateY(0); } }

        /* -- User list -- */
        .user-btn {
            display: flex; align-items: center; justify-content: space-between;
            padding: 15px 16px; border-radius: var(--r-md);
            border: 1.5px solid var(--border); background: var(--bg-card);
            font-weight: 500; font-size: 15px; text-align: left; width: 100%;
        }
        .user-btn:hover { border-color: var(--accent); background: var(--accent-soft); }

        /* -- Modal overlay (bottom sheet) -- */
        .modal-overlay {
            position: fixed; inset: 0; background: rgba(0,0,0,.35);
            backdrop-filter: blur(4px); z-index: 150;
            display: flex; align-items: flex-end; justify-content: center;
            padding: 0;
        }
        .modal {
            background: var(--bg-card); border-radius: var(--r-lg) var(--r-lg) 0 0;
            padding: 24px 20px 32px; width: 100%; max-width: 600px;
            max-height: 90dvh; overflow-y: auto;
            animation: slideUp .25s ease;
        }
        @keyframes slideUp { from { transform: translateY(100%); } to { transform: translateY(0); } }
        .modal-handle { width: 40px; height: 4px; background: var(--border);
                        border-radius: 2px; margin: 0 auto 20px; }

        /* -- Changelog -- */
        .changelog-list { list-style: none; padding: 0; }
        .changelog-item { font-size: 14px; color: var(--text-2); padding: 4px 0 4px 18px; position: relative; line-height: 1.5; }
        .changelog-item::before { content: ''; position: absolute; left: 0; top: 11px; width: 6px; height: 6px; border-radius: 50%; background: var(--text-3); }
        .changelog-version-block { padding: 16px 0; border-bottom: 1px solid var(--border); }
        .changelog-version-block:last-child { border-bottom: none; }
        .changelog-version-header { display: flex; align-items: baseline; gap: 10px; margin-bottom: 10px; }
        .version-number { font-size: 16px; font-weight: 700; color: var(--text); letter-spacing: -0.02em; }
        .version-date { font-size: 12px; color: var(--text-3); }
        .version-type { font-size: 10px; font-weight: 600; padding: 2px 8px; border-radius: 100px; text-transform: uppercase; letter-spacing: 0.04em; }
        .type-major { background: rgba(255,59,48,0.1); color: var(--danger); }
        .type-minor { background: rgba(0,122,255,0.1); color: var(--accent); }
        .type-patch { background: rgba(52,199,89,0.1); color: var(--success); }

        /* -- Offline banner -- */
        .offline-banner {
            position: fixed; top: 0; left: 0; right: 0; z-index: 200;
            background: var(--danger); color: #fff;
            text-align: center; padding: 10px 16px;
            font-size: 13px; font-weight: 600;
            animation: slideDown .3s ease;
        }
        @keyframes slideDown { from { transform: translateY(-100%); } to { transform: translateY(0); } }

        /* -- Divider -- */
        .divider { height: 1px; background: var(--border); margin: 16px 0; }

        /* -- Utilities -- */
        .gap-2  { display: flex; flex-direction: column; gap: 8px; }
        .gap-3  { display: flex; flex-direction: column; gap: 12px; }
        .gap-4  { display: flex; flex-direction: column; gap: 16px; }
        .row    { display: flex; gap: 10px; align-items: center; }
        .row-sb { display: flex; justify-content: space-between; align-items: center; }
        .mt-2   { margin-top: 8px; }  .mt-3 { margin-top: 12px; }  .mt-4 { margin-top: 16px; }
        .text-sm { font-size: 13px; }  .text-xs { font-size: 11px; }
        .text-2  { color: var(--text-2); }  .text-3 { color: var(--text-3); }
        .fw-6    { font-weight: 600; }  .fw-7 { font-weight: 700; }

        /* ================================================================
           CONTRACT-SPECIFIC STYLES
           ================================================================ */

        /* -- Stats bar -- */
        .stats-bar {
            display: flex; gap: 12px; flex-wrap: wrap;
            margin-bottom: 20px;
        }
        .stat-card {
            background: var(--bg-card); border-radius: var(--r-md);
            box-shadow: var(--shadow-sm); border: 1px solid var(--border);
            padding: 16px 20px; flex: 1; min-width: 140px;
        }
        .stat-value { font-size: 1.5rem; font-weight: 700; letter-spacing: -0.02em; }
        .stat-label { font-size: 0.85rem; color: var(--text-2); margin-top: 2px; }

        /* -- Filter bar -- */
        .filter-bar {
            display: flex; gap: 8px; margin-bottom: 16px; flex-wrap: wrap;
            align-items: center;
        }
        .filter-bar input, .filter-bar select {
            font-family: inherit; font-size: 14px; color: var(--text);
            background: var(--bg-elevated); border: 1.5px solid var(--border);
            border-radius: var(--r-sm); padding: 8px 12px;
            transition: border-color .18s, box-shadow .18s;
            -webkit-appearance: none; appearance: none;
            width: auto; min-width: 0;
        }
        .filter-bar input:focus, .filter-bar select:focus {
            outline: none; border-color: var(--accent); background: var(--bg-card);
            box-shadow: 0 0 0 3px var(--accent-badge);
        }
        .filter-bar input { flex: 1; min-width: 160px; }
        .filter-bar select { min-width: 120px; }

        /* -- Sort button -- */
        .sort-btn {
            font-family: inherit; font-size: 13px; font-weight: 500;
            color: var(--text-2); background: var(--bg-elevated);
            border: 1.5px solid var(--border); border-radius: var(--r-sm);
            padding: 8px 12px; cursor: pointer; white-space: nowrap;
            transition: all .18s;
        }
        .sort-btn:hover { border-color: var(--accent); color: var(--accent); }
        .sort-btn.active { background: var(--accent-soft); border-color: var(--accent); color: var(--accent); }

        /* -- Contracts table -- */
        .contracts-table {
            width: 100%; border-collapse: collapse;
            background: var(--bg-card); border-radius: var(--r-md);
            overflow: hidden; box-shadow: var(--shadow-sm);
            border: 1px solid var(--border);
            table-layout: fixed;
        }
        .contracts-table col.col-name { width: 25%; }
        .contracts-table col.col-category { width: 14%; }
        .contracts-table col.col-start { width: 11%; }
        .contracts-table col.col-cost { width: 15%; }
        .contracts-table col.col-cancel { width: 13%; }
        .contracts-table col.col-status { width: 12%; }
        .contracts-table col.col-actions { width: 10%; }
        .contracts-table th {
            background: var(--bg-elevated); color: var(--text-2);
            font-weight: 500; padding: 10px 14px; text-align: left;
            font-size: 13px; white-space: nowrap; cursor: pointer;
            user-select: none;
        }
        .contracts-table th:hover { color: var(--accent); }
        .contracts-table td {
            padding: 10px 14px; border-top: 1px solid var(--border);
            font-size: 14px; vertical-align: middle;
        }
        .contracts-table tr:hover td { background: var(--accent-soft); }

        /* -- Category badge -- */
        .category-badge {
            display: inline-block; border-radius: 6px; padding: 2px 8px;
            font-size: 0.8rem; font-weight: 500;
            background: var(--accent-badge); color: var(--accent);
        }

        /* -- Cancel urgency badge -- */
        .cancel-badge {
            display: inline-block; border-radius: 6px; padding: 2px 8px;
            font-size: 0.8rem; font-weight: 600; white-space: nowrap;
        }
        .cancel-badge.danger { background: rgba(255,59,48,0.1); color: var(--danger); }
        .cancel-badge.warning { background: rgba(255,159,10,0.1); color: var(--warning); }
        .cancel-badge.ok { background: rgba(52,199,89,0.1); color: var(--success); }

        /* -- Status badge -- */
        .status-badge {
            display: inline-block; border-radius: 6px; padding: 2px 8px;
            font-size: 0.8rem; font-weight: 600;
        }
        .status-badge.active { background: rgba(52,199,89,0.1); color: var(--success); }
        .status-badge.cancelled { background: var(--bg-elevated); color: var(--text-3); }
        .status-badge.expired { background: rgba(255,59,48,0.1); color: var(--danger); }

        /* -- Urgent contracts warning -- */
        .urgent-section {
            background: rgba(255,159,10,0.08); border: 1.5px solid rgba(255,159,10,0.2);
            border-radius: var(--r-md); padding: 16px; margin-bottom: 20px;
        }
        .urgent-section h3 { font-size: 15px; font-weight: 700; color: var(--warning); margin-bottom: 8px; display: flex; align-items: center; gap: 8px; }
        .urgent-item { font-size: 13px; color: var(--text); padding: 4px 0; }

        /* -- Form group -- */
        .form-group { margin-bottom: 16px; }
        .form-group label {
            display: block; font-size: 13px; font-weight: 600;
            color: var(--text-2); margin-bottom: 6px; letter-spacing: -0.01em;
        }
        .form-row { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; }

        /* -- Toggle switch -- */
        .toggle-switch {
            position: relative; display: inline-block;
            width: 44px; height: 26px; flex-shrink: 0;
        }
        .toggle-switch input { opacity: 0; width: 0; height: 0; }
        .toggle-slider {
            position: absolute; cursor: pointer; inset: 0;
            background: var(--bg-elevated); border: 1.5px solid var(--border);
            border-radius: 26px; transition: .2s;
        }
        .toggle-slider::before {
            content: ''; position: absolute; height: 20px; width: 20px;
            left: 2px; bottom: 2px; background: white;
            border-radius: 50%; transition: .2s;
            box-shadow: 0 1px 3px rgba(0,0,0,0.2);
        }
        .toggle-switch input:checked + .toggle-slider {
            background: var(--accent); border-color: var(--accent);
        }
        .toggle-switch input:checked + .toggle-slider::before {
            transform: translateX(18px);
        }

        /* -- Calculated preview -- */
        .calculated-preview {
            background: var(--bg-elevated); border: 1px solid var(--border);
            border-radius: var(--r-sm); padding: 12px 14px;
            font-size: 13px; color: var(--text-2);
        }
        .calculated-preview .preview-row {
            display: flex; justify-content: space-between;
            padding: 2px 0;
        }
        .calculated-preview .preview-label { color: var(--text-3); }
        .calculated-preview .preview-value { font-weight: 600; color: var(--text); }

        /* -- FAB (floating action button) -- */
        .fab {
            position: fixed; bottom: 24px; right: 24px; z-index: 100;
            width: 56px; height: 56px; border-radius: 50%;
            background: var(--accent); color: #fff;
            display: flex; align-items: center; justify-content: center;
            box-shadow: var(--shadow-lg);
            transition: all .18s;
        }
        .fab:hover { background: var(--accent-h); transform: scale(1.05); box-shadow: 0 8px 30px var(--accent-glow); }
        .fab:active { transform: scale(0.95); }

        /* -- Contract card (mobile) -- */
        .contract-card {
            background: var(--bg-card); border-radius: var(--r-md);
            box-shadow: var(--shadow-sm); border: 1px solid var(--border);
            padding: 14px 16px; margin-bottom: 10px;
        }
        .contract-card-header { display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 8px; }
        .contract-card-name { font-weight: 600; font-size: 15px; }
        .contract-card-details { display: flex; flex-wrap: wrap; gap: 8px; font-size: 13px; color: var(--text-2); }
        .contract-card-actions { display: flex; gap: 6px; margin-top: 10px; justify-content: flex-end; }

        /* -- Desktop: show table, hide cards -- */
        .desktop-table { display: block; }
        .mobile-cards { display: none; }

        /* -- Empty state -- */
        .empty-state {
            text-align: center; padding: 48px 20px;
            color: var(--text-3);
        }
        .empty-state svg { margin-bottom: 12px; opacity: 0.4; }
        .empty-state p { font-size: 15px; }

        @media (max-width: 768px) {
            .desktop-table { display: none; }
            .mobile-cards { display: block; }
            .stats-bar { flex-direction: column; }
            .stat-card { min-width: auto; }
            .filter-bar { flex-direction: column; }
            .filter-bar input, .filter-bar select { width: 100%; }
            .form-row { grid-template-columns: 1fr; }
            input[type="text"], input[type="number"], input[type="date"], textarea, select { font-size: 16px; }
            .nav-left { flex-direction: column; align-items: flex-start; gap: 2px; }
            .nav-date-mobile { display: inline; }
            .nav-date-desktop { display: none; }
        }

        @media (max-width: 640px) {
            .card { border-radius: var(--r-md); }
        }
    </style>
</head>
<body>
    <div id="app"></div>

    <script>
        // Theme: abends (19-7 Uhr) automatisch Dark Mode
        window.__isEvening = function() {
            var h = new Date().getHours();
            return h >= 19 || h < 7;
        };
        (function() {
            var saved = localStorage.getItem('theme');
            var shouldDark = saved === 'dark' || (saved !== 'light' && window.__isEvening());
            if (shouldDark) document.documentElement.setAttribute('data-theme', 'dark');
        })();
    </script>

    <script>
        // ============ CONFIG ============
        const API_BASE = window.location.origin;
        const API_KEY = '%%API_KEY%%';
        const NODE_ENV = '%%NODE_ENV%%';

        const app = document.getElementById('app');

        // ============ ESCAPE HTML ============
        function escapeHtml(str) {
            if (str == null) return '';
            return String(str).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;').replace(/'/g,'&#39;');
        }

        // ============ STATE ============
        const state = {
            view: 'loading',
            users: [],
            user: localStorage.getItem('contracts_user') || '',
            userId: null,
            selectedUser: '',
            passwordMode: null,
            showPw: false,
            contracts: [],
            groups: [],
            stats: null,
            categories: [],
            filter: { category: '', status: '', search: '', group: '' },
            sort: { field: 'cancellation_date', dir: 'asc' },
            modal: null,
            showCategoryStats: localStorage.getItem('contracts_showCategoryStats') !== 'false',
            showGroupStats: localStorage.getItem('contracts_showGroupStats') !== 'false',
            hideExpiredCancelled: localStorage.getItem('contracts_hideExpiredCancelled') !== 'false',
            showExpiredSection: false,
            isOnline: navigator.onLine,
            version: '',
            theme: localStorage.getItem('theme') || 'auto'
        };

        let formState = null;
        let settingsState = { importing: false, confirmDelete: false, deleting: false, editGroup: null };
        let changelogData = null;
        let toasts = [];
        let _pwLocal = '';
        let _pw2Local = '';
        let _pwBusy = false;
        let _savingContract = false;

        // ============ API LAYER ============
        async function apiCall(endpoint, options = {}) {
            const headers = { 'Content-Type': 'application/json', 'x-api-key': API_KEY, ...options.headers };
            const sessionToken = localStorage.getItem('contracts_session');
            if (sessionToken) headers['x-session-token'] = sessionToken;
            const response = await fetch(endpoint, { ...options, headers });
            if (!response.ok) {
                const data = await response.json().catch(() => ({}));
                throw new Error(data.error || 'Anfrage fehlgeschlagen');
            }
            return response;
        }

        // ============ DYNAMIC FAVICON ============
        const ENV_CONFIG = {
            development: { label: 'DEV', color: '#007aff' },
            test:        { label: 'TEST', color: '#ff9f0a' },
            production:  { label: 'PROD', color: '#34c759' }
        };

        (function setFavicon() {
            const env = ENV_CONFIG[NODE_ENV] || ENV_CONFIG.development;
            const svg = `<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 32 32">
                <rect width="32" height="32" rx="8" fill="${env.color}"/>
                <path d="M9 6h9l6 6v14a2 2 0 0 1-2 2H9a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2z" fill="rgba(255,255,255,0.9)"/>
                <path d="M18 6v6h6" fill="rgba(255,255,255,0.7)" stroke="rgba(255,255,255,0.9)" stroke-width="0.5"/>
                <line x1="10" y1="16" x2="20" y2="16" stroke="${env.color}" stroke-width="1.5" stroke-linecap="round"/>
                <line x1="10" y1="19.5" x2="18" y2="19.5" stroke="${env.color}" stroke-width="1.5" stroke-linecap="round"/>
                <line x1="10" y1="23" x2="16" y2="23" stroke="${env.color}" stroke-width="1.5" stroke-linecap="round"/>
            </svg>`;
            document.getElementById('favicon').href = 'data:image/svg+xml,' + encodeURIComponent(svg);
            if (NODE_ENV !== 'production') {
                document.title = `[${env.label}] Vertragsmanagement`;
            }
        })();

        // ============ THEME ============
        let _themeInterval = null;
        function applyTheme(isDark) {
            document.documentElement.setAttribute('data-theme', isDark ? 'dark' : 'light');
        }
        function startThemeAuto() {
            if (_themeInterval) clearInterval(_themeInterval);
            if (state.theme === 'auto') {
                applyTheme(window.__isEvening());
                _themeInterval = setInterval(() => applyTheme(window.__isEvening()), 60000);
            }
        }
        function cycleTheme() {
            const next = state.theme === 'auto' ? 'dark' : state.theme === 'dark' ? 'light' : 'auto';
            state.theme = next;
            localStorage.setItem('theme', next);
            if (next === 'auto') { startThemeAuto(); }
            else { if (_themeInterval) { clearInterval(_themeInterval); _themeInterval = null; } applyTheme(next === 'dark'); }
            render();
        }
        function themeIcon() {
            if (state.theme === 'auto') return iconAuto();
            return document.documentElement.getAttribute('data-theme') === 'dark' ? iconSun() : iconMoon();
        }
        function themeTitle() {
            return state.theme === 'auto' ? 'Auto (abends dunkel)' : state.theme === 'dark' ? 'Immer dunkel' : 'Immer hell';
        }
        startThemeAuto();

        // ============ TOAST ============
        function showToast(message, type = 'success') {
            const id = Date.now() + Math.random();
            toasts.push({ id, message, type });
            renderToastContainer();
            setTimeout(() => { toasts = toasts.filter(t => t.id !== id); renderToastContainer(); }, 2500);
        }
        function renderToastContainer() {
            let el = document.getElementById('toast-container');
            if (!el) { el = document.createElement('div'); el.id = 'toast-container'; el.className = 'toast-container'; document.body.appendChild(el); }
            el.innerHTML = toasts.map(t => `<div class="toast toast-${escapeHtml(t.type)}">${escapeHtml(t.message)}</div>`).join('');
        }

        // ============ ICONS ============
        function iconSun() { return '<svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8" stroke-linecap="round"><circle cx="12" cy="12" r="4.5"/><line x1="12" y1="1.5" x2="12" y2="4"/><line x1="12" y1="20" x2="12" y2="22.5"/><line x1="4.22" y1="4.22" x2="5.99" y2="5.99"/><line x1="18.01" y1="18.01" x2="19.78" y2="19.78"/><line x1="1.5" y1="12" x2="4" y2="12"/><line x1="20" y1="12" x2="22.5" y2="12"/><line x1="4.22" y1="19.78" x2="5.99" y2="18.01"/><line x1="18.01" y1="5.99" x2="19.78" y2="4.22"/></svg>'; }
        function iconMoon() { return '<svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8" stroke-linecap="round"><path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"/></svg>'; }
        function iconAuto() { return '<svg width="18" height="18" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><circle cx="12" cy="12" r="9"/><path d="M12 3v1m0 16v1m-9-9h1m16 0h1m-2.64-6.36l-.7.7m-11.32 11.32l-.7.7m0-12.72l.7.7m11.32 11.32l.7.7"/></svg>'; }
        function iconPlus() { return '<svg width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round"><line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/></svg>'; }
        function iconEdit() { return '<svg width="15" height="15" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8" stroke-linecap="round"><path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"/><path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"/></svg>'; }
        function iconTrash() { return '<svg width="15" height="15" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8" stroke-linecap="round"><polyline points="3 6 5 6 21 6"/><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/></svg>'; }
        function iconDownload() { return '<svg width="18" height="18" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path d="M21 15v4a2 2 0 01-2 2H5a2 2 0 01-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" y1="15" x2="12" y2="3"/></svg>'; }
        function iconUpload() { return '<svg width="18" height="18" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path d="M21 15v4a2 2 0 01-2 2H5a2 2 0 01-2-2v-4"/><polyline points="17 8 12 3 7 8"/><line x1="12" y1="3" x2="12" y2="15"/></svg>'; }
        function iconSearch() { return '<svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"><circle cx="11" cy="11" r="8"/><line x1="21" y1="21" x2="16.65" y2="16.65"/></svg>'; }
        function iconFilter() { return '<svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"><polygon points="22 3 2 3 10 12.46 10 19 14 21 14 12.46 22 3"/></svg>'; }
        function iconChevronDown() { return '<svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"><polyline points="6 9 12 15 18 9"/></svg>'; }
        function iconX() { return '<svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg>'; }
        function iconCheck() { return '<svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round"><polyline points="20 6 9 17 4 12"/></svg>'; }
        function iconLogout() { return '<svg width="18" height="18" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path d="M9 21H5a2 2 0 01-2-2V5a2 2 0 012-2h4"/><polyline points="16 17 21 12 16 7"/><line x1="21" y1="12" x2="9" y2="12"/></svg>'; }
        function iconFileText() { return '<svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8" stroke-linecap="round"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/><polyline points="14 2 14 8 20 8"/><line x1="16" y1="13" x2="8" y2="13"/><line x1="16" y1="17" x2="8" y2="17"/><polyline points="10 9 9 9 8 9"/></svg>'; }
        function iconDollarSign() { return '<svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"><line x1="12" y1="1" x2="12" y2="23"/><path d="M17 5H9.5a3.5 3.5 0 0 0 0 7h5a3.5 3.5 0 0 1 0 7H6"/></svg>'; }
        function iconCalendar() { return '<svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8" stroke-linecap="round"><rect x="3" y="4" width="18" height="18" rx="3"/><line x1="16" y1="2" x2="16" y2="6"/><line x1="8" y1="2" x2="8" y2="6"/><line x1="3" y1="10" x2="21" y2="10"/></svg>'; }
        function iconAlertTriangle() { return '<svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"><path d="M10.29 3.86L1.82 18a2 2 0 0 0 1.71 3h16.94a2 2 0 0 0 1.71-3L13.71 3.86a2 2 0 0 0-3.42 0z"/><line x1="12" y1="9" x2="12" y2="13"/><line x1="12" y1="17" x2="12.01" y2="17"/></svg>'; }
        function iconUser() { return '<svg width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8" stroke-linecap="round"><path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"/><circle cx="12" cy="7" r="4"/></svg>'; }
        function iconLock() { return '<svg width="18" height="18" fill="none" stroke="currentColor" stroke-width="1.8" viewBox="0 0 24 24"><rect x="3" y="11" width="18" height="11" rx="2"/><path d="M7 11V7a5 5 0 0110 0v4"/></svg>'; }
        function iconSettings() { return '<svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="3"/><path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1-2.83 2.83l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-4 0v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83-2.83l.06-.06A1.65 1.65 0 0 0 4.68 15a1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1 0-4h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 2.83-2.83l.06.06A1.65 1.65 0 0 0 9 4.68a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 4 0v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 2.83l-.06.06A1.65 1.65 0 0 0 19.4 9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 0 4h-.09a1.65 1.65 0 0 0-1.51 1z"/></svg>'; }
        function iconBack() { return '<svg width="18" height="18" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><line x1="19" y1="12" x2="5" y2="12"/><polyline points="12 19 5 12 12 5"/></svg>'; }
        function iconEye() { return '<svg width="18" height="18" fill="none" stroke="currentColor" stroke-width="1.8" viewBox="0 0 24 24"><path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"/><circle cx="12" cy="12" r="3"/></svg>'; }
        function iconEyeOff() { return '<svg width="18" height="18" fill="none" stroke="currentColor" stroke-width="1.8" viewBox="0 0 24 24"><path d="M17.94 17.94A10.07 10.07 0 0112 20c-7 0-11-8-11-8a18.45 18.45 0 015.06-5.94M9.9 4.24A9.12 9.12 0 0112 4c7 0 11 8 11 8a18.5 18.5 0 01-2.16 3.19m-6.72-1.07a3 3 0 11-4.24-4.24"/><line x1="1" y1="1" x2="23" y2="23"/></svg>'; }
        function iconArrowUp() { return '<svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round"><polyline points="18 15 12 9 6 15"/></svg>'; }
        function iconArrowDown() { return '<svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round"><polyline points="6 9 12 15 18 9"/></svg>'; }

        // ============ ENV BADGE ============
        function envBadge() {
            const env = ENV_CONFIG[NODE_ENV] || ENV_CONFIG.development;
            return `<span class="env-badge badge-${escapeHtml(NODE_ENV)}">${escapeHtml(env.label)}</span>`;
        }

        // ============ HELPERS ============
        function formatDate(dateStr) {
            if (!dateStr) return '-';
            return new Date(dateStr + 'T12:00:00').toLocaleDateString('de-DE');
        }
        function formatCost(cost) {
            return parseFloat(cost).toFixed(2).replace('.', ',') + ' \u20ac';
        }
        function getDaysUntil(dateStr) {
            if (!dateStr) return Infinity;
            const target = new Date(dateStr + 'T00:00:00');
            const now = new Date();
            now.setHours(0, 0, 0, 0);
            return Math.ceil((target - now) / (1000 * 60 * 60 * 24));
        }
        function getCancelUrgency(contract) {
            if (contract.status !== 'active' || !contract.notify) return 'ok';
            const days = getDaysUntil(contract.cancellation_date);
            if (days < 0) return 'ok';
            const warnDays = contract.cancel_warn_days || 90;
            if (days <= Math.ceil(warnDays / 3)) return 'danger';
            if (days <= warnDays) return 'warning';
            return 'ok';
        }
        function getCancelLabel(contract) {
            if (contract.status !== 'active') return formatDate(contract.cancellation_date);
            const days = getDaysUntil(contract.cancellation_date);
            if (days < 0) return contract.auto_renew ? `Verl. ${formatDate(contract.end_date)}` : 'Abgelaufen';
            if (days === 0) return 'Heute!';
            if (days === 1) return 'Morgen!';
            if (days <= (contract.cancel_warn_days || 90)) return `${days} Tage`;
            return formatDate(contract.cancellation_date);
        }
        function sortIndicator(field) {
            if (state.sort.field !== field) return '';
            return state.sort.dir === 'asc' ? iconArrowUp() : iconArrowDown();
        }
        function getIntervalLabel(bi) {
            return bi === 'quarterly' ? 'Quartal' : bi === 'semi-annual' ? 'Halbjahr' : 'Jahr';
        }
        function getIntervalLabelShort(bi) {
            return bi === 'quarterly' ? 'Q' : bi === 'semi-annual' ? 'HJ' : 'J';
        }
        function getIntervalDivisor(bi) {
            return { monthly: 1, quarterly: 3, 'semi-annual': 6, annual: 12 }[bi] || 1;
        }
        function autoResizeTextarea(el) {
            if (!el) return;
            el.style.height = 'auto';
            el.style.height = el.scrollHeight + 'px';
        }

        // ============ FILTERING & SORTING ============
        function getFilteredContracts() {
            let filtered = [...state.contracts];
            if (state.hideExpiredCancelled && !state.filter.status) {
                const today = new Date().toISOString().split('T')[0];
                filtered = filtered.filter(c => {
                    if (c.status === 'expired') return false;
                    if (c.status === 'cancelled') {
                        if (c.end_date && c.end_date < today) return false;
                        if (c.cancellation_date && c.cancellation_date < today) return false;
                    }
                    return true;
                });
            }
            if (state.filter.search) {
                const s = state.filter.search.toLowerCase();
                filtered = filtered.filter(c =>
                    c.name.toLowerCase().includes(s) ||
                    c.category.toLowerCase().includes(s) ||
                    (c.description && c.description.toLowerCase().includes(s)) ||
                    (c.notes && c.notes.toLowerCase().includes(s)) ||
                    (c.customer_number && c.customer_number.toLowerCase().includes(s)) ||
                    (c.contract_number && c.contract_number.toLowerCase().includes(s))
                );
            }
            if (state.filter.category) filtered = filtered.filter(c => c.category === state.filter.category);
            if (state.filter.group) filtered = filtered.filter(c => c.group_id === Number(state.filter.group));
            if (state.filter.status) filtered = filtered.filter(c => c.status === state.filter.status);

            filtered.sort((a, b) => {
                let valA, valB;
                switch (state.sort.field) {
                    case 'name': valA = a.name.toLowerCase(); valB = b.name.toLowerCase(); break;
                    case 'monthly_cost': valA = a.monthly_cost; valB = b.monthly_cost; break;
                    case 'cancellation_date': valA = a.cancellation_date || '9999-99-99'; valB = b.cancellation_date || '9999-99-99'; break;
                    case 'category': valA = a.category; valB = b.category; break;
                    case 'start_date': valA = a.start_date || ''; valB = b.start_date || ''; break;
                    default: valA = a.name.toLowerCase(); valB = b.name.toLowerCase();
                }
                if (valA < valB) return state.sort.dir === 'asc' ? -1 : 1;
                if (valA > valB) return state.sort.dir === 'asc' ? 1 : -1;
                return 0;
            });
            return filtered;
        }

        function getExpiredContracts() {
            if (!state.hideExpiredCancelled || state.filter.status) return [];
            const today = new Date().toISOString().split('T')[0];
            return state.contracts.filter(c => {
                if (c.status === 'expired') return true;
                if (c.status === 'cancelled') {
                    if (c.end_date && c.end_date < today) return true;
                    if (c.cancellation_date && c.cancellation_date < today) return true;
                }
                return false;
            });
        }

        function getUrgentContracts() {
            return state.contracts.filter(c => {
                if (c.status !== 'active' || !c.notify) return false;
                const days = getDaysUntil(c.cancellation_date);
                return days >= 0 && days <= (c.cancel_warn_days || 90);
            }).sort((a, b) => getDaysUntil(a.cancellation_date) - getDaysUntil(b.cancellation_date));
        }

        // ============ DATA LOADING ============
        async function loadUsers() {
            try {
                const r = await apiCall(`${API_BASE}/api/users`);
                state.users = await r.json();
            } catch (e) {}
        }

        async function loadContracts() {
            try {
                const [contractsRes, statsRes] = await Promise.all([
                    apiCall(`${API_BASE}/api/contracts`),
                    apiCall(`${API_BASE}/api/contracts/stats`)
                ]);
                state.contracts = await contractsRes.json();
                state.stats = await statsRes.json();
                render();
            } catch (e) {
                showToast('Fehler beim Laden der Vertr\u00e4ge', 'error');
            }
        }

        async function loadGroups() {
            try {
                const res = await apiCall(`${API_BASE}/api/groups`);
                state.groups = await res.json();
                render();
            } catch (e) {}
        }

        async function saveGroup(group) {
            const method = group.id ? 'PUT' : 'POST';
            const url = group.id ? `${API_BASE}/api/groups/${group.id}` : `${API_BASE}/api/groups`;
            await apiCall(url, { method, body: JSON.stringify(group) });
            await loadGroups();
            await loadContracts();
        }

        async function deleteGroup(id) {
            await apiCall(`${API_BASE}/api/groups/${id}`, { method: 'DELETE' });
            await loadGroups();
            await loadContracts();
        }

        // ============ AUTH HANDLERS ============
        function handleUserClick(userObj) {
            state.selectedUser = userObj.name;
            state.showPw = false;
            _pwLocal = ''; _pw2Local = '';
            state.passwordMode = userObj.hasPassword ? 'login' : 'set-password';
            render();
        }

        function handleNewUser(name) {
            if (!name || !name.trim()) return;
            const n = name.trim();
            if (state.users.find(u => u.name === n)) {
                showToast('Benutzer existiert bereits', 'error');
                return;
            }
            state.selectedUser = n;
            state.showPw = false;
            _pwLocal = ''; _pw2Local = '';
            state.passwordMode = 'register';
            render();
        }

        async function handleLogin(password) {
            try {
                const r = await apiCall(`${API_BASE}/api/auth/login`, {
                    method: 'POST', body: JSON.stringify({ user: state.selectedUser, password })
                });
                const data = await r.json();
                if (data.success) {
                    if (data.token) localStorage.setItem('contracts_session', data.token);
                    localStorage.setItem('contracts_user', state.selectedUser);
                    state.user = state.selectedUser;
                    state.view = 'dashboard';
                    state.passwordMode = null;
                    render();
                    loadContracts(); loadGroups();
                } else if (data.needsPassword) {
                    state.passwordMode = 'set-password';
                    render();
                }
            } catch (e) {
                showToast(e.message || 'Anmeldung fehlgeschlagen', 'error');
            }
        }

        async function handleSetPassword(password) {
            try {
                const r = await apiCall(`${API_BASE}/api/auth/set-password`, {
                    method: 'POST', body: JSON.stringify({ user: state.selectedUser, password })
                });
                const data = await r.json();
                if (data.success) {
                    if (data.token) localStorage.setItem('contracts_session', data.token);
                    localStorage.setItem('contracts_user', state.selectedUser);
                    state.user = state.selectedUser;
                    state.view = 'dashboard';
                    state.passwordMode = null;
                    render();
                    loadContracts(); loadGroups();
                }
            } catch (e) {
                showToast(e.message || 'Fehler beim Setzen des Passworts', 'error');
            }
        }

        async function handleRegister(password) {
            try {
                const r = await apiCall(`${API_BASE}/api/users/${encodeURIComponent(state.selectedUser)}`, {
                    method: 'POST', body: JSON.stringify({ password })
                });
                const data = await r.json();
                if (data.success) {
                    if (data.token) localStorage.setItem('contracts_session', data.token);
                    localStorage.setItem('contracts_user', state.selectedUser);
                    state.user = state.selectedUser;
                    state.view = 'dashboard';
                    state.passwordMode = null;
                    render();
                    loadContracts(); loadGroups();
                }
            } catch (e) {
                showToast(e.message || 'Fehler beim Erstellen', 'error');
            }
        }

        function handlePasswordBack() {
            state.passwordMode = null;
            state.selectedUser = '';
            state.showPw = false;
            _pwLocal = ''; _pw2Local = '';
            render();
        }

        async function handleLogout() {
            const token = localStorage.getItem('contracts_session');
            if (token) { try { await apiCall(`${API_BASE}/api/auth/logout`, { method: 'POST', body: JSON.stringify({ token }) }); } catch (_) {} }
            localStorage.removeItem('contracts_session');
            localStorage.removeItem('contracts_user');
            state.user = ''; state.userId = null; state.contracts = []; state.stats = null;
            state.view = 'login'; state.passwordMode = null; state.selectedUser = '';
            state.modal = null;
            await loadUsers();
            render();
        }

        // ============ CONTRACT HANDLERS ============
        async function handleSaveContract() {
            if (!formState || !formState.name.trim()) return;
            _savingContract = true;
            render();
            try {
                const payload = {
                    ...formState,
                    group_id: formState.group_id || null,
                    duration_months: parseInt(formState.duration_months),
                    cancellation_period_months: parseInt(formState.cancellation_period_months),
                    cost: parseFloat(formState.cost),
                    billing_interval: formState.billing_interval,
                    cashback: formState.cashback || undefined,
                    notify: formState.notify,
                    cancel_warn_days: parseInt(formState.cancel_warn_days) || 90,
                    split_count: parseInt(formState.split_count) || 1,
                    cancelled_at: formState.status === 'cancelled' ? (formState.cancelled_at || null) : null,
                    cancellation_confirmed: formState.status === 'cancelled' ? formState.cancellation_confirmed : false,
                    customer_number: formState.customer_number || undefined,
                    contract_number: formState.contract_number || undefined,
                    cancellation_date_override: formState.cancellation_date_override || null,
                };
                if (state.modal && state.modal.data && state.modal.data.id) {
                    await apiCall(`${API_BASE}/api/contracts/${state.modal.data.id}`, {
                        method: 'PUT', body: JSON.stringify(payload)
                    });
                    showToast('Vertrag aktualisiert');
                } else {
                    await apiCall(`${API_BASE}/api/contracts`, {
                        method: 'POST', body: JSON.stringify(payload)
                    });
                    showToast('Vertrag erstellt');
                }
                closeModal();
                loadContracts();
            } catch (e) {
                showToast(e.message || 'Fehler beim Speichern', 'error');
            } finally {
                _savingContract = false;
            }
        }

        async function handleDeleteContract() {
            if (!state.modal || state.modal.type !== 'delete-confirm') return;
            const { id, name } = state.modal.data;
            try {
                await apiCall(`${API_BASE}/api/contracts/${id}`, { method: 'DELETE' });
                showToast(`"${name}" gel\u00f6scht`);
                closeModal();
                loadContracts();
            } catch (e) {
                showToast(e.message || 'Fehler beim L\u00f6schen', 'error');
            }
        }

        // ============ MODAL ============
        function showModal(type, data = null) {
            state.modal = { type, data };
            if (type === 'contract-form') {
                _savingContract = false;
                const c = data;
                if (c) {
                    formState = {
                        name: c.name, category: c.category, group_id: c.group_id || '',
                        start_date: c.start_date, duration_months: c.duration_months,
                        cancellation_period_months: c.cancellation_period_months,
                        cost: c.cost !== undefined ? c.cost : c.monthly_cost,
                        billing_interval: c.billing_interval || 'monthly',
                        cashback: c.cashback || '', notify: c.notify !== undefined ? !!c.notify : true,
                        cancel_warn_days: c.cancel_warn_days || 90, split_count: c.split_count || 1,
                        description: c.description || '', auto_renew: !!c.auto_renew,
                        notes: c.notes || '', status: c.status || 'active',
                        cancelled_at: c.cancelled_at || '', cancellation_confirmed: !!c.cancellation_confirmed,
                        customer_number: c.customer_number || '', contract_number: c.contract_number || '',
                        cancellation_date_override: c.cancellation_date_override || ''
                    };
                } else {
                    formState = {
                        name: '', category: state.categories[0] || 'Internet', group_id: '',
                        start_date: new Date().toISOString().split('T')[0], duration_months: 24,
                        cancellation_period_months: 3, cost: 0, billing_interval: 'monthly',
                        cashback: '', notify: true, cancel_warn_days: 90, split_count: 1,
                        description: '', auto_renew: true, notes: '', status: 'active',
                        cancelled_at: '', cancellation_confirmed: false, customer_number: '',
                        contract_number: '', cancellation_date_override: ''
                    };
                }
            } else if (type === 'settings') {
                settingsState = { importing: false, confirmDelete: false, deleting: false, editGroup: null };
            } else if (type === 'changelog') {
                changelogData = null;
                fetch(`${API_BASE}/api/changelog`).then(r => r.json()).then(data => { changelogData = data; render(); }).catch(() => { changelogData = []; render(); });
            }
            render();
        }
        function closeModal() {
            state.modal = null;
            formState = null;
            render();
        }

        // ============ FORM PREVIEW ============
        function calculatePreviewDates() {
            if (!formState || !formState.start_date || !formState.duration_months) return null;
            const start = new Date(formState.start_date);
            const end = new Date(start);
            end.setMonth(end.getMonth() + parseInt(formState.duration_months));
            const now = new Date();
            if (formState.auto_renew) {
                while (end <= now) end.setMonth(end.getMonth() + parseInt(formState.duration_months));
            }
            const cancel = new Date(end);
            cancel.setMonth(cancel.getMonth() - parseInt(formState.cancellation_period_months || 0));
            const cancelDate = formState.cancellation_date_override
                ? new Date(formState.cancellation_date_override + 'T12:00:00').toLocaleDateString('de-DE')
                : cancel.toLocaleDateString('de-DE');
            return {
                end_date: end.toLocaleDateString('de-DE'),
                cancellation_date: cancelDate,
                isOverridden: !!formState.cancellation_date_override
            };
        }

        // ============ RENDER: LOADING ============
        function renderLoading() {
            return `<div style="min-height:100dvh;background:var(--bg);display:flex;align-items:center;justify-content:center">
                ${!state.isOnline ? '<div class="offline-banner">Keine Verbindung -- \u00c4nderungen werden nicht gespeichert</div>' : ''}
                <p class="text-2" style="font-size:16px;font-weight:500">L\u00e4dt...</p>
            </div>`;
        }

        // ============ RENDER: LOGIN ============
        function renderLogin() {
            let pwSection = '';
            if (state.passwordMode) {
                const needsConfirm = state.passwordMode === 'set-password' || state.passwordMode === 'register';
                const title = state.passwordMode === 'login' ? 'Anmelden' :
                              state.passwordMode === 'set-password' ? 'Passwort erstellen' : 'Neuer Benutzer';
                const subtitle = state.passwordMode === 'login' ? `Passwort f\u00fcr ${escapeHtml(state.selectedUser)}` :
                                 state.passwordMode === 'set-password' ? `Erstelle ein Passwort f\u00fcr ${escapeHtml(state.selectedUser)}` :
                                 `Passwort f\u00fcr ${escapeHtml(state.selectedUser)} festlegen`;
                pwSection = `<div class="gap-3">
                    <div>
                        <button class="btn btn-ghost" data-action="password-back" style="margin-bottom:8px;margin-left:-8px;color:var(--accent);gap:4px;border-radius:var(--r-sm);font-size:14px">
                            ${iconBack()} Zur\u00fcck
                        </button>
                        <div class="row" style="gap:10px;margin-bottom:4px">
                            ${iconLock()}
                            <span class="fw-7" style="font-size:17px">${escapeHtml(title)}</span>
                        </div>
                        <p class="text-sm text-2">${escapeHtml(subtitle)}</p>
                    </div>
                    <div class="pw-field">
                        <input type="${state.showPw ? 'text' : 'password'}" data-field="pw" value="${escapeHtml(_pwLocal)}" placeholder="Passwort" id="pw-input">
                        <button class="pw-toggle" type="button" data-action="toggle-pw" tabindex="-1">
                            ${state.showPw ? iconEyeOff() : iconEye()}
                        </button>
                    </div>
                    ${needsConfirm ? `<div class="pw-field">
                        <input type="${state.showPw ? 'text' : 'password'}" data-field="pw2" value="${escapeHtml(_pw2Local)}" placeholder="Passwort bestaetigen" id="pw2-input">
                    </div>` : ''}
                    <button class="btn btn-primary btn-full" data-action="submit-password" ${_pwBusy ? 'disabled' : ''} style="opacity:${_pwBusy ? '0.6' : '1'}">
                        ${_pwBusy ? 'Bitte warten...' : state.passwordMode === 'login' ? 'Anmelden' : 'Passwort setzen'}
                    </button>
                </div>`;
            } else {
                let usersList = '';
                if (state.users.length > 0) {
                    usersList = `<div style="margin-bottom:20px">
                        <div class="gap-2">
                            ${state.users.map(u => `<div class="row" style="gap:8px">
                                <button class="user-btn" data-action="select-user" data-user="${escapeHtml(u.name)}" data-has-password="${u.hasPassword ? '1' : '0'}" style="flex:1">
                                    <span>${escapeHtml(u.name)}</span>
                                    ${u.hasPassword ? iconLock() : ''}
                                </button>
                            </div>`).join('')}
                        </div>
                        <div class="row" style="margin:20px 0;gap:12px">
                            <div style="flex:1;height:1px;background:var(--border)"></div>
                            <span class="text-xs text-3">oder neu</span>
                            <div style="flex:1;height:1px;background:var(--border)"></div>
                        </div>
                    </div>`;
                }
                pwSection = `${usersList}
                    <input type="text" placeholder="Dein Name..." style="margin-bottom:12px" id="new-user-input" ${state.users.length === 0 ? 'autofocus' : ''}>
                    <button class="btn btn-primary btn-full" data-action="new-user">Starten</button>`;
            }

            return `<div style="min-height:100dvh;background:var(--bg);display:flex;align-items:center;justify-content:center;padding:20px">
                ${!state.isOnline ? '<div class="offline-banner">Keine Verbindung -- \u00c4nderungen werden nicht gespeichert</div>' : ''}
                <div class="card" style="padding:36px 32px;max-width:400px;width:100%">
                    <div style="text-align:center;margin-bottom:28px">
                        <div style="width:52px;height:52px;border-radius:16px;background:var(--accent-soft);display:inline-flex;align-items:center;justify-content:center;color:var(--accent);margin-bottom:16px">
                            ${iconFileText()}
                        </div>
                        <h1 style="font-size:24px;font-weight:700;letter-spacing:-0.03em">Vertragsmanagement</h1>
                        ${!state.passwordMode ? `<p class="text-sm text-2 mt-2">${state.users.length > 0 ? 'Waehle deinen Benutzer' : 'Wie heisst du?'}</p>` : ''}
                        <p class="text-xs text-3 mt-2">
                            ${state.version ? `<span style="cursor:pointer;text-decoration:underline dotted" data-action="show-changelog">v${escapeHtml(state.version)}</span>` : ''}
                            ${state.version ? ' \u00b7 ' : ''}${envBadge()}
                        </p>
                    </div>
                    ${pwSection}
                    <div class="row" style="justify-content:center;margin-top:16px">
                        <button class="btn btn-ghost" title="${themeTitle()}" data-action="toggle-theme">${themeIcon()}</button>
                    </div>
                </div>
                ${state.modal && state.modal.type === 'changelog' ? renderChangelogModal() : ''}
            </div>`;
        }

        // ============ RENDER: MODALS ============
        function renderChangelogModal() {
            let content = '';
            if (!changelogData) {
                content = '<p class="text-2" style="padding:24px 0;text-align:center">L\u00e4dt...</p>';
            } else {
                content = changelogData.map(entry => `<div class="changelog-version-block">
                    <div class="changelog-version-header">
                        <span class="version-number">v${escapeHtml(entry.version)}</span>
                        <span class="version-type type-${escapeHtml(entry.type)}">${escapeHtml(entry.type)}</span>
                        <span class="version-date">${new Date(entry.date + 'T12:00:00').toLocaleDateString('de-DE', { day: 'numeric', month: 'short', year: 'numeric' })}</span>
                    </div>
                    <ul class="changelog-list">
                        ${entry.changes.map(change => `<li class="changelog-item">${escapeHtml(change)}</li>`).join('')}
                    </ul>
                </div>`).join('');
            }
            return `<div class="modal-overlay" data-action="close-modal">
                <div class="modal" data-stop-propagation>
                    <div class="modal-handle"></div>
                    <h3 class="fw-7" style="font-size:17px;margin-bottom:16px">Changelog</h3>
                    <div class="gap-4" style="max-height:60dvh;overflow-y:auto">${content}</div>
                    <button class="btn btn-secondary btn-full mt-4" data-action="close-modal">Schlie\u00dfen</button>
                </div>
            </div>`;
        }

        function renderDeleteConfirmModal() {
            if (!state.modal || state.modal.type !== 'delete-confirm') return '';
            return `<div class="modal-overlay" data-action="close-modal">
                <div class="modal" data-stop-propagation>
                    <div class="modal-handle"></div>
                    <h3 class="fw-7" style="font-size:17px;margin-bottom:8px">Wirklich l\u00f6schen?</h3>
                    <p class="text-sm text-2" style="margin-bottom:20px;line-height:1.5">
                        <strong>"${escapeHtml(state.modal.data.name)}"</strong> wird unwiderruflich gel\u00f6scht.
                    </p>
                    <div class="row" style="gap:10px">
                        <button class="btn btn-secondary btn-full" data-action="close-modal">Abbrechen</button>
                        <button class="btn btn-danger btn-full" data-action="confirm-delete">L\u00f6schen</button>
                    </div>
                </div>
            </div>`;
        }

        function renderSettingsModal() {
            if (!state.modal || state.modal.type !== 'settings') return '';
            const groups = state.groups;

            let groupsList = groups.map(g => `<div style="display:flex;align-items:center;gap:8px;margin-bottom:8px">
                <span style="width:14px;height:14px;border-radius:50%;background-color:${escapeHtml(g.color || 'var(--text-secondary)')};display:inline-block;flex-shrink:0"></span>
                <span style="flex:1">${escapeHtml(g.name)}</span>
                <button class="btn btn-sm btn-secondary" data-action="edit-group" data-group-id="${g.id}" data-group-name="${escapeHtml(g.name)}" data-group-color="${escapeHtml(g.color || '#4CAF50')}">Bearbeiten</button>
                <button class="btn btn-sm btn-danger" data-action="delete-group" data-group-id="${g.id}">L\u00f6schen</button>
            </div>`).join('');

            let editGroupSection = '';
            if (groups.length < 10 && !settingsState.editGroup) {
                editGroupSection = `<button class="btn btn-sm btn-secondary" data-action="new-group">+ Neue Gruppe</button>`;
            }
            if (settingsState.editGroup) {
                editGroupSection = `<div style="display:flex;gap:8px;margin-top:8px;align-items:center">
                    <input type="text" placeholder="Gruppenname" maxlength="50" data-field="group-name" value="${escapeHtml(settingsState.editGroup.name)}" style="flex:1">
                    <input type="color" data-field="group-color" value="${escapeHtml(settingsState.editGroup.color || '#4CAF50')}" style="width:40px;height:34px;padding:2px;cursor:pointer">
                    <button class="btn btn-primary btn-sm" data-action="save-group">Speichern</button>
                    <button class="btn btn-sm btn-secondary" data-action="cancel-edit-group">Abbrechen</button>
                </div>`;
            }

            let accountSection = '';
            if (!settingsState.confirmDelete) {
                accountSection = `<button class="btn btn-danger btn-full" data-action="confirm-delete-account">Account l\u00f6schen</button>`;
            } else {
                accountSection = `<p class="text-sm text-2" style="line-height:1.5">
                    Dein Account <strong>"${escapeHtml(state.user)}"</strong> und alle ${state.contracts.length} Vertr\u00e4ge werden unwiderruflich gel\u00f6scht.
                </p>
                <div class="row" style="gap:10px;margin-top:12px">
                    <button class="btn btn-secondary btn-full" data-action="cancel-delete-account">Abbrechen</button>
                    <button class="btn btn-danger btn-full" data-action="delete-account" ${settingsState.deleting ? 'disabled' : ''}>
                        ${settingsState.deleting ? 'L\u00f6sche...' : 'Endg\u00fcltig l\u00f6schen'}
                    </button>
                </div>`;
            }

            return `<div class="modal-overlay" data-action="close-modal">
                <div class="modal" data-stop-propagation>
                    <div class="modal-handle"></div>
                    <h3 class="fw-7" style="font-size:17px;margin-bottom:16px">Daten exportieren</h3>
                    <div class="gap-3">
                        <button class="btn btn-primary btn-full" data-action="export" data-format="json">Als JSON exportieren</button>
                        <button class="btn btn-secondary btn-full" data-action="export" data-format="csv">Als CSV exportieren (Excel-kompatibel)</button>
                        <p class="text-xs text-3" style="text-align:center">Alle Vertr\u00e4ge werden heruntergeladen.</p>
                    </div>
                    <div class="divider"></div>
                    <h3 class="fw-7" style="font-size:17px;margin-bottom:16px">Daten importieren</h3>
                    <div class="gap-3">
                        <input type="file" accept=".json" id="import-file" style="font-size:14px">
                        <button class="btn btn-primary btn-full" data-action="import" ${settingsState.importing ? 'disabled' : ''}>
                            ${settingsState.importing ? 'Importiere...' : 'JSON importieren'}
                        </button>
                        <p class="text-xs text-3" style="text-align:center">Importiert eine zuvor exportierte JSON-Datei.</p>
                    </div>
                    <div class="divider"></div>
                    <h3 class="fw-7" style="font-size:17px;margin-bottom:16px">Vertragsgruppen</h3>
                    <div class="gap-3">${groupsList}${editGroupSection}</div>
                    <div class="divider"></div>
                    <h3 class="fw-7" style="font-size:17px;margin-bottom:16px">Anzeige</h3>
                    <div class="gap-3">
                        <div style="display:flex;align-items:center;justify-content:space-between">
                            <label style="margin:0;font-size:14px">Kosten nach Kategorie</label>
                            <label class="toggle-switch">
                                <input type="checkbox" data-field="showCategoryStats" ${state.showCategoryStats ? 'checked' : ''}>
                                <span class="toggle-slider"></span>
                            </label>
                        </div>
                        <div style="display:flex;align-items:center;justify-content:space-between">
                            <label style="margin:0;font-size:14px">Gruppenkosten anzeigen</label>
                            <label class="toggle-switch">
                                <input type="checkbox" data-field="showGroupStats" ${state.showGroupStats ? 'checked' : ''}>
                                <span class="toggle-slider"></span>
                            </label>
                        </div>
                        <div style="display:flex;align-items:center;justify-content:space-between">
                            <label style="margin:0;font-size:14px">Abgelaufene Vertr\u00e4ge ausblenden</label>
                            <label class="toggle-switch">
                                <input type="checkbox" data-field="hideExpiredCancelled" ${state.hideExpiredCancelled ? 'checked' : ''}>
                                <span class="toggle-slider"></span>
                            </label>
                        </div>
                    </div>
                    <div class="divider"></div>
                    <h3 class="fw-7" style="font-size:17px;margin-bottom:16px">Account</h3>
                    <div class="gap-3">${accountSection}</div>
                    <div style="margin-top:16px">
                        <button class="btn btn-ghost btn-full" data-action="close-modal">Schlie\u00dfen</button>
                    </div>
                </div>
            </div>`;
        }

        // ============ RENDER: CONTRACT FORM MODAL ============
        function renderContractFormModal() {
            if (!state.modal || state.modal.type !== 'contract-form' || !formState) return '';
            const isEdit = !!(state.modal.data && state.modal.data.id);
            const f = formState;
            const preview = calculatePreviewDates();

            let previewHtml = '';
            if (preview) {
                let costRows = '';
                const costVal = parseFloat(f.cost);
                if (costVal > 0 && f.billing_interval && f.billing_interval !== 'monthly') {
                    costRows += `<div class="preview-row" style="margin-top:4px;border-top:1px solid var(--border);padding-top:4px">
                        <span class="preview-label">Monatliche Kosten</span>
                        <span class="preview-value">${(costVal / getIntervalDivisor(f.billing_interval)).toFixed(2).replace('.', ',')} \u20ac</span>
                    </div>`;
                }
                if (costVal > 0) {
                    const isMonthly = f.billing_interval === 'monthly';
                    costRows += `<div class="preview-row" style="margin-top:${isMonthly ? '4' : '0'}px;border-top:${isMonthly ? '1px solid var(--border)' : 'none'};padding-top:${isMonthly ? '4' : '0'}px">
                        <span class="preview-label">J\u00e4hrliche Kosten</span>
                        <span class="preview-value">${(costVal / getIntervalDivisor(f.billing_interval) * 12).toFixed(2).replace('.', ',')} \u20ac</span>
                    </div>`;
                }
                previewHtml = `<div class="calculated-preview" style="margin-bottom:16px">
                    <div style="font-size:12px;font-weight:600;color:var(--text-3);margin-bottom:6px;text-transform:uppercase;letter-spacing:0.04em">Berechnete Termine</div>
                    <div class="preview-row">
                        <span class="preview-label">Vertragsende</span>
                        <span class="preview-value">${escapeHtml(preview.end_date)}</span>
                    </div>
                    <div class="preview-row">
                        <span class="preview-label">K\u00fcndigungsdatum${preview.isOverridden ? ' (manuell)' : ''}</span>
                        <span class="preview-value">${escapeHtml(preview.cancellation_date)}</span>
                    </div>
                    ${costRows}
                </div>`;
            }

            let cancelledSection = '';
            if (f.status === 'cancelled') {
                cancelledSection = `<div class="form-group">
                        <label>Gek\u00fcndigt am</label>
                        <input type="date" data-field="cancelled_at" value="${escapeHtml(f.cancelled_at)}">
                    </div>
                    <div class="form-group">
                        <div style="display:flex;align-items:center;justify-content:space-between">
                            <label style="margin:0">K\u00fcndigung best\u00e4tigt</label>
                            <label class="toggle-switch">
                                <input type="checkbox" data-field="cancellation_confirmed" ${f.cancellation_confirmed ? 'checked' : ''}>
                                <span class="toggle-slider"></span>
                            </label>
                        </div>
                    </div>`;
            }

            let notifySection = '';
            if (f.notify) {
                notifySection = `<div class="form-group">
                    <label>Warnzeitraum (Tage)</label>
                    <input type="number" data-field="cancel_warn_days" value="${escapeHtml(f.cancel_warn_days)}" min="1" max="365">
                </div>`;
            }

            return `<div class="modal-overlay" data-action="close-modal">
                <div class="modal" data-stop-propagation>
                    <div class="modal-handle"></div>
                    <h3 class="fw-7" style="font-size:17px;margin-bottom:16px">
                        ${isEdit ? 'Vertrag bearbeiten' : 'Neuer Vertrag'}
                    </h3>
                    <form id="contract-form" data-action="save-contract">
                        <div class="form-group">
                            <label>Name *</label>
                            <input type="text" data-field="name" value="${escapeHtml(f.name)}" placeholder="z.B. Telekom DSL" required id="contract-name-input">
                        </div>
                        <div class="form-group">
                            <label>Kategorie</label>
                            <select data-field="category">
                                ${state.categories.map(c => `<option value="${escapeHtml(c)}" ${f.category === c ? 'selected' : ''}>${escapeHtml(c)}</option>`).join('')}
                            </select>
                        </div>
                        <div class="form-group">
                            <label>Gruppe</label>
                            <select data-field="group_id">
                                <option value="">Keine Gruppe</option>
                                ${state.groups.map(g => `<option value="${g.id}" ${f.group_id == g.id ? 'selected' : ''}>${escapeHtml(g.name)}</option>`).join('')}
                            </select>
                        </div>
                        <div class="form-row">
                            <div class="form-group">
                                <label>Startdatum</label>
                                <input type="date" data-field="start_date" value="${escapeHtml(f.start_date)}">
                            </div>
                            <div class="form-group">
                                <label>Laufzeit (Monate)</label>
                                <input type="number" data-field="duration_months" value="${escapeHtml(f.duration_months)}" min="1" max="600">
                            </div>
                        </div>
                        <div class="form-row">
                            <div class="form-group">
                                <label>K\u00fcndigungsfrist (Monate)</label>
                                <input type="number" data-field="cancellation_period_months" value="${escapeHtml(f.cancellation_period_months)}" min="0" max="24">
                            </div>
                            <div class="form-group">
                                <label>K\u00fcndigungsdatum ${f.cancellation_date_override ? '(manuell)' : '(optional)'}</label>
                                <input type="date" data-field="cancellation_date_override" value="${escapeHtml(f.cancellation_date_override)}">
                            </div>
                        </div>
                        <div class="form-row">
                            <div class="form-group">
                                <label>Kosten (\u20ac)</label>
                                <input type="number" data-field="cost" value="${escapeHtml(f.cost)}" min="0" max="99999" step="0.01">
                            </div>
                        </div>
                        <div class="form-group">
                            <label>Zahlungsintervall</label>
                            <select data-field="billing_interval">
                                <option value="monthly" ${f.billing_interval === 'monthly' ? 'selected' : ''}>Monatlich</option>
                                <option value="quarterly" ${f.billing_interval === 'quarterly' ? 'selected' : ''}>Quartalsweise</option>
                                <option value="semi-annual" ${f.billing_interval === 'semi-annual' ? 'selected' : ''}>Halbj\u00e4hrlich</option>
                                <option value="annual" ${f.billing_interval === 'annual' ? 'selected' : ''}>J\u00e4hrlich</option>
                            </select>
                        </div>
                        <div class="form-row">
                            <div class="form-group">
                                <label>Cashback</label>
                                <textarea maxlength="200" placeholder="z.B. 25 \u20ac via Check24" rows="1" data-field="cashback" style="overflow:hidden">${escapeHtml(f.cashback)}</textarea>
                            </div>
                            <div class="form-group">
                                <label>Geteilt mit (Personen)</label>
                                <input type="number" data-field="split_count" value="${escapeHtml(f.split_count)}" min="1" max="20">
                            </div>
                        </div>
                        <div class="form-row">
                            <div class="form-group">
                                <label>Kundennummer</label>
                                <input type="text" maxlength="100" placeholder="Optional" data-field="customer_number" value="${escapeHtml(f.customer_number)}">
                            </div>
                            <div class="form-group">
                                <label>Vertragsnummer</label>
                                <input type="text" maxlength="100" placeholder="Optional" data-field="contract_number" value="${escapeHtml(f.contract_number)}">
                            </div>
                        </div>
                        <div class="form-group">
                            <label>Beschreibung</label>
                            <textarea data-field="description" placeholder="Optionale Beschreibung..." rows="2" style="overflow:hidden">${escapeHtml(f.description)}</textarea>
                        </div>
                        <div class="form-group">
                            <label>Notizen</label>
                            <textarea data-field="notes" placeholder="Optionale Notizen..." rows="2" style="overflow:hidden">${escapeHtml(f.notes)}</textarea>
                        </div>
                        <div class="form-group">
                            <div style="display:flex;align-items:center;justify-content:space-between">
                                <label style="margin:0">Auto-Verl\u00e4ngerung</label>
                                <label class="toggle-switch">
                                    <input type="checkbox" data-field="auto_renew" ${f.auto_renew ? 'checked' : ''}>
                                    <span class="toggle-slider"></span>
                                </label>
                            </div>
                        </div>
                        <div class="form-group">
                            <div style="display:flex;align-items:center;justify-content:space-between">
                                <label style="margin:0">K\u00fcndigungswarnung</label>
                                <label class="toggle-switch">
                                    <input type="checkbox" data-field="notify" ${f.notify ? 'checked' : ''}>
                                    <span class="toggle-slider"></span>
                                </label>
                            </div>
                        </div>
                        ${notifySection}
                        <div class="form-group">
                            <label>Status</label>
                            <select data-field="status">
                                <option value="active" ${f.status === 'active' ? 'selected' : ''}>Aktiv</option>
                                <option value="cancelled" ${f.status === 'cancelled' ? 'selected' : ''}>Gek\u00fcndigt</option>
                            </select>
                        </div>
                        ${cancelledSection}
                        ${previewHtml}
                        <div class="row" style="gap:10px">
                            <button type="button" class="btn btn-secondary btn-full" data-action="close-modal">Abbrechen</button>
                            <button type="submit" class="btn btn-primary btn-full" ${_savingContract ? 'disabled' : ''} style="opacity:${_savingContract ? '0.6' : '1'}">
                                ${_savingContract ? 'Speichere...' : (isEdit ? 'Speichern' : 'Erstellen')}
                            </button>
                        </div>
                    </form>
                </div>
            </div>`;
        }

        // ============ RENDER: DASHBOARD ============
        function renderDashboard() {
            const filteredContracts = getFilteredContracts();
            const urgentContracts = getUrgentContracts();
            const activeCount = state.contracts.filter(c => c.status === 'active').length;
            const usedCategories = [...new Set(state.contracts.map(c => c.category))];
            const expiredContracts = getExpiredContracts();
            const today = new Date().toLocaleDateString('de-DE', { weekday: 'short', day: 'numeric', month: 'short', year: 'numeric' });

            // Stats bar
            let statsHtml = '';
            if (state.stats) {
                const s = state.stats;
                statsHtml = `<div class="stats-bar">
                    <div class="stat-card">
                        <div class="stat-value" style="color:var(--accent)">${s.totalMonthly.toFixed(2).replace('.', ',')} \u20ac</div>
                        <div class="stat-label">Monatlich gesamt</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value" style="color:var(--accent)">${(s.totalMonthlyEffective ?? s.totalMonthly).toFixed(2).replace('.', ',')} \u20ac</div>
                        <div class="stat-label">Dein Anteil / Monat</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value" style="color:var(--warning)">${(s.totalYearlyEffective ?? s.totalYearly).toFixed(2).replace('.', ',')} \u20ac</div>
                        <div class="stat-label">Dein Anteil / Jahr</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value" style="color:var(--success)">${activeCount}</div>
                        <div class="stat-label">Aktive Vertr\u00e4ge</div>
                    </div>
                </div>`;
            }

            // Urgent contracts
            let urgentHtml = '';
            if (urgentContracts.length > 0) {
                urgentHtml = `<div class="urgent-section">
                    <h3>${iconAlertTriangle()} K\u00fcndigungsfristen beachten!</h3>
                    ${urgentContracts.map(c => {
                        const days = getDaysUntil(c.cancellation_date);
                        const warnDays = c.cancel_warn_days || 90;
                        return `<div class="urgent-item">
                            <strong>${escapeHtml(c.name)}</strong> \u2013
                            <span class="cancel-badge ${days <= Math.ceil(warnDays / 3) ? 'danger' : 'warning'}">
                                ${days === 0 ? 'Heute!' : days === 1 ? 'Morgen!' : `${days} Tage`}
                            </span>
                            <span class="text-3" style="margin-left:8px;font-size:12px">(${formatDate(c.cancellation_date)})</span>
                        </div>`;
                    }).join('')}
                </div>`;
            }

            // Filter bar
            let groupFilter = '';
            if (state.groups.length > 0) {
                groupFilter = `<select data-field="filter-group">
                    <option value="">Alle Gruppen</option>
                    ${state.groups.map(g => `<option value="${g.id}" ${state.filter.group == g.id ? 'selected' : ''}>${escapeHtml(g.name)}</option>`).join('')}
                </select>`;
            }

            const filterHtml = `<div class="filter-bar">
                <input type="text" placeholder="Suchen..." data-field="filter-search" value="${escapeHtml(state.filter.search)}">
                <select data-field="filter-category">
                    <option value="">Alle Kategorien</option>
                    ${usedCategories.map(c => `<option value="${escapeHtml(c)}" ${state.filter.category === c ? 'selected' : ''}>${escapeHtml(c)}</option>`).join('')}
                </select>
                ${groupFilter}
                <select data-field="filter-status">
                    <option value="">Alle Status</option>
                    <option value="active" ${state.filter.status === 'active' ? 'selected' : ''}>Aktiv</option>
                    <option value="cancelled" ${state.filter.status === 'cancelled' ? 'selected' : ''}>Gek\u00fcndigt</option>
                </select>
                <button class="sort-btn ${state.sort.field === 'name' ? 'active' : ''}" data-action="sort" data-sort-field="name">Name ${sortIndicator('name')}</button>
                <button class="sort-btn ${state.sort.field === 'monthly_cost' ? 'active' : ''}" data-action="sort" data-sort-field="monthly_cost">Kosten ${sortIndicator('monthly_cost')}</button>
                <button class="sort-btn ${state.sort.field === 'cancellation_date' ? 'active' : ''}" data-action="sort" data-sort-field="cancellation_date">K\u00fcndigung ${sortIndicator('cancellation_date')}</button>
            </div>`;

            // Empty state
            let contentHtml = '';
            if (filteredContracts.length === 0) {
                contentHtml = `<div class="empty-state">
                    ${iconFileText()}
                    <p>${state.contracts.length === 0 ? 'Noch keine Vertr\u00e4ge vorhanden.' : 'Keine Vertr\u00e4ge f\u00fcr diesen Filter.'}</p>
                    ${state.contracts.length === 0 ? `<button class="btn btn-primary mt-4" data-action="new-contract">${iconPlus()} Ersten Vertrag anlegen</button>` : ''}
                </div>`;
            } else {
                // Desktop table
                contentHtml += `<div class="desktop-table"><table class="contracts-table">
                    <colgroup><col class="col-name"><col class="col-category"><col class="col-start"><col class="col-cost"><col class="col-cancel"><col class="col-status"><col class="col-actions"></colgroup>
                    <thead><tr>
                        <th data-action="sort" data-sort-field="name">Name ${sortIndicator('name')}</th>
                        <th data-action="sort" data-sort-field="category">Kategorie ${sortIndicator('category')}</th>
                        <th data-action="sort" data-sort-field="start_date">Startdatum ${sortIndicator('start_date')}</th>
                        <th data-action="sort" data-sort-field="monthly_cost" style="text-align:right">Mtl. Kosten ${sortIndicator('monthly_cost')}</th>
                        <th data-action="sort" data-sort-field="cancellation_date">K\u00fcndigung bis ${sortIndicator('cancellation_date')}</th>
                        <th>Status</th>
                        <th style="width:90px"></th>
                    </tr></thead>
                    <tbody>${filteredContracts.map(c => renderContractRow(c)).join('')}</tbody>
                </table></div>`;
                // Mobile cards
                contentHtml += `<div class="mobile-cards">${filteredContracts.map(c => renderContractCard(c)).join('')}</div>`;
            }

            // Category stats
            let categoryStatsHtml = '';
            if (state.showCategoryStats && state.stats && state.stats.categories && state.stats.categories.length > 0) {
                categoryStatsHtml = `<div style="margin-top:24px">
                    <h3 class="fw-6 text-2" style="font-size:14px;margin-bottom:12px">Kosten nach Kategorie</h3>
                    <div class="card" style="overflow:hidden">
                        ${state.stats.categories.map((cat, i) => `<div style="display:flex;justify-content:space-between;align-items:center;padding:10px 16px;${i > 0 ? 'border-top:1px solid var(--border)' : ''}">
                            <div>
                                <span class="category-badge">${escapeHtml(cat.category)}</span>
                                <span class="text-xs text-3" style="margin-left:8px">${cat.count} ${cat.count === 1 ? 'Vertrag' : 'Vertr\u00e4ge'}</span>
                            </div>
                            <div style="text-align:right">
                                <span style="font-weight:600;font-size:14px;font-variant-numeric:tabular-nums">${(cat.monthly_total || 0).toFixed(2).replace('.', ',')} \u20ac</span>
                                <span class="text-xs text-3" style="margin-left:4px">/ Monat</span>
                            </div>
                        </div>`).join('')}
                    </div>
                </div>`;
            }

            // Group stats
            let groupStatsHtml = '';
            if (state.showGroupStats && state.stats && state.stats.groups && state.stats.groups.length > 0) {
                groupStatsHtml = `<div style="margin-top:24px">
                    <h3 class="fw-6 text-2" style="font-size:14px;margin-bottom:12px">Kosten nach Gruppe</h3>
                    <div class="card" style="overflow:hidden">
                        ${state.stats.groups.map((g, i) => `<div style="display:flex;align-items:center;gap:8px;padding:10px 16px;${i > 0 ? 'border-top:1px solid var(--border)' : ''}">
                            <span style="width:12px;height:12px;border-radius:50%;background-color:${escapeHtml(g.group_color || 'var(--text-secondary)')};flex-shrink:0"></span>
                            <span style="flex:1;font-weight:500">${escapeHtml(g.group_name)}</span>
                            <span style="color:var(--text-2);font-size:0.85rem">${g.count} ${g.count === 1 ? 'Vertrag' : 'Vertr\u00e4ge'}</span>
                            <span style="font-weight:600;font-variant-numeric:tabular-nums">${g.monthly_total.toFixed(2).replace('.', ',')} \u20ac/mtl.</span>
                        </div>`).join('')}
                    </div>
                </div>`;
            }

            // Expired section
            let expiredHtml = '';
            if (expiredContracts.length > 0) {
                let expiredContent = '';
                if (state.showExpiredSection) {
                    expiredContent = `<div class="desktop-table"><table class="contracts-table">
                        <colgroup><col class="col-name"><col class="col-category"><col class="col-start"><col class="col-cost"><col class="col-cancel"><col class="col-status"><col class="col-actions"></colgroup>
                        <thead><tr><th>Name</th><th>Kategorie</th><th>Start</th><th style="text-align:right">Kosten</th><th>K\u00fcndigung</th><th>Status</th><th></th></tr></thead>
                        <tbody>${expiredContracts.map(c => renderExpiredRow(c)).join('')}</tbody>
                    </table></div>
                    <div class="mobile-cards">${expiredContracts.map(c => renderExpiredCard(c)).join('')}</div>`;
                }
                expiredHtml = `<div style="margin-top:24px;opacity:0.7">
                    <h3 class="fw-6 text-2" style="font-size:14px;margin-bottom:12px;cursor:pointer;display:flex;align-items:center;gap:6px;user-select:none" data-action="toggle-expired">
                        <span style="display:inline-block;transition:transform 0.2s;transform:${state.showExpiredSection ? 'rotate(90deg)' : 'rotate(0deg)'};font-size:12px">\u25b6</span>
                        Abgelaufene Vertr\u00e4ge (${expiredContracts.length})
                    </h3>
                    ${expiredContent}
                </div>`;
            }

            // Modal
            let modalHtml = '';
            if (state.modal) {
                if (state.modal.type === 'contract-form') modalHtml = renderContractFormModal();
                else if (state.modal.type === 'settings') modalHtml = renderSettingsModal();
                else if (state.modal.type === 'changelog') modalHtml = renderChangelogModal();
                else if (state.modal.type === 'delete-confirm') modalHtml = renderDeleteConfirmModal();
            }

            return `<div class="page">
                ${!state.isOnline ? '<div class="offline-banner">Keine Verbindung -- \u00c4nderungen werden nicht gespeichert</div>' : ''}
                <nav class="nav"><div class="nav-inner">
                    <div class="nav-left">
                        <span class="nav-title">Vertragsmanagement</span>
                        <span class="nav-meta">
                            ${state.version ? `<span class="text-xs text-3" style="cursor:pointer;text-decoration:underline dotted" data-action="show-changelog" title="Changelog">v${escapeHtml(state.version)}</span>` : ''}
                            ${envBadge()}
                            <span class="nav-date-mobile text-xs text-3">${today}</span>
                        </span>
                    </div>
                    <div class="row" style="gap:4px">
                        <span class="nav-date-desktop text-xs text-3" style="margin-right:4px">${today}</span>
                        <span class="text-xs text-2" style="margin-right:4px">${escapeHtml(state.user)}</span>
                        <button class="btn btn-ghost" title="${themeTitle()}" data-action="toggle-theme">${themeIcon()}</button>
                        <button class="btn btn-ghost" title="Einstellungen" data-action="show-settings">${iconSettings()}</button>
                        <button class="btn btn-ghost" title="Abmelden" data-action="logout">${iconLogout()}</button>
                    </div>
                </div></nav>
                <div class="max-w" style="padding-top:20px">
                    ${statsHtml}${urgentHtml}${filterHtml}${contentHtml}${categoryStatsHtml}${groupStatsHtml}${expiredHtml}
                </div>
                <button class="fab" title="Neuer Vertrag" data-action="new-contract">${iconPlus()}</button>
                ${modalHtml}
            </div>`;
        }

        // ============ CONTRACT ROW/CARD RENDERERS ============
        function renderContractRow(c) {
            const urgency = getCancelUrgency(c);
            let nameExtra = '';
            if (c.auto_renew && c.status !== 'cancelled') nameExtra = '<span class="text-xs text-3" style="margin-left:6px" title="Auto-Verl\u00e4ngerung">&#x21bb;</span>';
            let numInfo = '';
            if (c.customer_number || c.contract_number) {
                numInfo = '<div class="text-xs text-3">';
                if (c.customer_number) numInfo += `<span>KdNr. ${escapeHtml(c.customer_number)}</span>`;
                if (c.customer_number && c.contract_number) numInfo += '<span> \u00b7 </span>';
                if (c.contract_number) numInfo += `<span>VNr. ${escapeHtml(c.contract_number)}</span>`;
                numInfo += '</div>';
            }
            let groupBadge = '';
            if (c.group_name) {
                groupBadge = `<span style="background-color:${escapeHtml(c.group_color || 'var(--text-secondary)')};color:#fff;border-radius:6px;padding:2px 8px;font-size:0.75rem;margin-left:4px;display:inline-block">${escapeHtml(c.group_name)}</span>`;
            }
            let costExtra = '';
            if (c.billing_interval && c.billing_interval !== 'monthly') {
                costExtra += `<div class="text-3" style="font-size:11px">(${formatCost(c.cost)}/${getIntervalLabel(c.billing_interval)})</div>`;
            }
            if (c.split_count > 1) {
                costExtra += `<div class="text-3" style="font-size:11px">1/${c.split_count} = ${formatCost(c.monthly_cost / c.split_count)}</div>`;
            }
            let cancelExtra = '';
            if (urgency === 'ok' && c.status === 'active' && !(c.auto_renew && getDaysUntil(c.cancellation_date) < 0)) {
                cancelExtra = `<span class="text-xs text-3" style="margin-left:6px">${formatDate(c.cancellation_date)}</span>`;
            }
            let statusExtra = '';
            if (c.status === 'cancelled' && c.cancelled_at) {
                statusExtra += `<div class="text-xs text-3" style="margin-top:3px">am ${formatDate(c.cancelled_at)}</div>`;
            }
            if (c.status === 'cancelled' && !!c.cancellation_confirmed) {
                statusExtra += '<div class="text-xs" style="color:var(--success);margin-top:2px">Best\u00e4tigt</div>';
            }

            return `<tr>
                <td><span style="font-weight:500">${escapeHtml(c.name)}</span>${nameExtra}${numInfo}</td>
                <td><span class="category-badge">${escapeHtml(c.category)}</span>${groupBadge}</td>
                <td>${formatDate(c.start_date)}</td>
                <td style="text-align:right;font-variant-numeric:tabular-nums">
                    <span style="font-weight:600">${formatCost(c.monthly_cost)}</span><span class="text-3" style="font-size:11px">/mtl.</span>
                    ${costExtra}
                </td>
                <td><span class="cancel-badge ${urgency}">${escapeHtml(getCancelLabel(c))}</span>${cancelExtra}</td>
                <td><span class="status-badge ${escapeHtml(c.status)}">${c.status === 'active' ? 'Aktiv' : c.status === 'cancelled' ? 'Gek\u00fcndigt' : escapeHtml(c.status)}</span>${statusExtra}</td>
                <td><div class="row" style="gap:4px;justify-content:flex-end">
                    <button class="btn btn-ghost" title="Bearbeiten" data-action="edit-contract" data-contract-id="${c.id}">${iconEdit()}</button>
                    <button class="btn btn-ghost" title="L\u00f6schen" style="color:var(--danger)" data-action="delete-contract" data-contract-id="${c.id}" data-contract-name="${escapeHtml(c.name)}">${iconTrash()}</button>
                </div></td>
            </tr>`;
        }

        function renderContractCard(c) {
            const urgency = getCancelUrgency(c);
            let nameExtra = '';
            if (c.auto_renew && c.status !== 'cancelled') nameExtra = '<span class="text-xs text-3" style="margin-left:6px">&#x21bb;</span>';
            let groupBadge = '';
            if (c.group_name) {
                groupBadge = `<span style="background-color:${escapeHtml(c.group_color || 'var(--text-secondary)')};color:#fff;border-radius:6px;padding:2px 8px;font-size:0.75rem;margin-left:4px;display:inline-block">${escapeHtml(c.group_name)}</span>`;
            }
            let billingExtra = '';
            if (c.billing_interval && c.billing_interval !== 'monthly') {
                billingExtra = `<span class="text-3" style="font-size:11px;margin-left:4px">(${formatCost(c.cost)}/${getIntervalLabelShort(c.billing_interval)})</span>`;
            }
            let splitExtra = '';
            if (c.split_count > 1) {
                splitExtra = `<span class="text-3" style="font-size:11px;margin-left:4px">(1/${c.split_count})</span>`;
            }
            let statusExtra = '';
            if (c.status === 'cancelled' && c.cancelled_at) {
                statusExtra += `<div class="text-xs text-3" style="margin-top:3px">am ${formatDate(c.cancelled_at)}</div>`;
            }
            if (c.status === 'cancelled' && !!c.cancellation_confirmed) {
                statusExtra += '<div class="text-xs" style="color:var(--success);margin-top:2px">Best\u00e4tigt</div>';
            }

            return `<div class="contract-card">
                <div class="contract-card-header">
                    <div>
                        <div class="contract-card-name">${escapeHtml(c.name)}${nameExtra}</div>
                        <span class="category-badge" style="margin-top:4px">${escapeHtml(c.category)}</span>${groupBadge}
                    </div>
                    <div>
                        <span class="status-badge ${escapeHtml(c.status)}">${c.status === 'active' ? 'Aktiv' : 'Gek\u00fcndigt'}</span>
                        ${statusExtra}
                    </div>
                </div>
                <div class="contract-card-details">
                    <span>Start: ${formatDate(c.start_date)}</span>
                    ${c.customer_number ? `<span>KdNr. ${escapeHtml(c.customer_number)}</span>` : ''}
                    ${c.contract_number ? `<span>VNr. ${escapeHtml(c.contract_number)}</span>` : ''}
                    <span><strong>${formatCost(c.monthly_cost)}</strong> / Monat${billingExtra}${splitExtra}</span>
                    <span>K\u00fcndigung: <span class="cancel-badge ${urgency}">${escapeHtml(getCancelLabel(c))}</span></span>
                </div>
                <div class="contract-card-actions">
                    <button class="btn btn-sm btn-secondary" data-action="edit-contract" data-contract-id="${c.id}">${iconEdit()} Bearbeiten</button>
                    <button class="btn btn-sm btn-danger" data-action="delete-contract" data-contract-id="${c.id}" data-contract-name="${escapeHtml(c.name)}">${iconTrash()}</button>
                </div>
            </div>`;
        }

        function renderExpiredRow(c) {
            let numInfo = '';
            if (c.customer_number) numInfo += `<div class="text-xs text-3">KdNr. ${escapeHtml(c.customer_number)}</div>`;
            if (c.contract_number) numInfo += `<div class="text-xs text-3">VNr. ${escapeHtml(c.contract_number)}</div>`;
            let costExtra = '';
            if (c.billing_interval && c.billing_interval !== 'monthly') {
                costExtra += `<div class="text-3" style="font-size:11px">(${formatCost(c.cost)}/${getIntervalLabel(c.billing_interval)})</div>`;
            }
            if (c.split_count > 1) {
                costExtra += `<div class="text-3" style="font-size:11px">1/${c.split_count} = ${formatCost(c.monthly_cost / c.split_count)}</div>`;
            }
            let statusExtra = '';
            if (c.status === 'cancelled' && c.cancelled_at) {
                statusExtra += `<div class="text-xs text-3" style="margin-top:3px">am ${formatDate(c.cancelled_at)}</div>`;
            }
            if (c.status === 'cancelled' && !!c.cancellation_confirmed) {
                statusExtra += '<div class="text-xs" style="color:var(--success);margin-top:2px">Best\u00e4tigt</div>';
            }
            return `<tr>
                <td><div style="font-weight:600">${escapeHtml(c.name)}</div>${numInfo}</td>
                <td><span class="category-badge">${escapeHtml(c.category)}</span></td>
                <td>${formatDate(c.start_date)}</td>
                <td style="text-align:right;font-variant-numeric:tabular-nums">
                    <span style="font-weight:600">${formatCost(c.monthly_cost)}</span><span class="text-3" style="font-size:11px">/mtl.</span>${costExtra}
                </td>
                <td>${formatDate(c.cancellation_date)}</td>
                <td><span class="status-badge ${escapeHtml(c.status)}">${c.status === 'expired' ? 'Abgelaufen' : 'Gek\u00fcndigt'}</span>${statusExtra}</td>
                <td><div class="row" style="gap:4px;justify-content:flex-end">
                    <button class="btn btn-ghost" title="Bearbeiten" data-action="edit-contract" data-contract-id="${c.id}">${iconEdit()}</button>
                    <button class="btn btn-ghost" title="L\u00f6schen" style="color:var(--danger)" data-action="delete-contract" data-contract-id="${c.id}" data-contract-name="${escapeHtml(c.name)}">${iconTrash()}</button>
                </div></td>
            </tr>`;
        }

        function renderExpiredCard(c) {
            let billingExtra = '';
            if (c.billing_interval && c.billing_interval !== 'monthly') {
                billingExtra = `<span class="text-3" style="font-size:11px;margin-left:4px">(${formatCost(c.cost)}/${getIntervalLabelShort(c.billing_interval)})</span>`;
            }
            let splitExtra = '';
            if (c.split_count > 1) {
                splitExtra = `<span class="text-3" style="font-size:11px;margin-left:4px">(1/${c.split_count})</span>`;
            }
            let statusExtra = '';
            if (c.status === 'cancelled' && c.cancelled_at) {
                statusExtra += `<div class="text-xs text-3" style="margin-top:3px">am ${formatDate(c.cancelled_at)}</div>`;
            }
            if (c.status === 'cancelled' && !!c.cancellation_confirmed) {
                statusExtra += '<div class="text-xs" style="color:var(--success);margin-top:2px">Best\u00e4tigt</div>';
            }
            return `<div class="contract-card">
                <div class="contract-card-header">
                    <div>
                        <div class="contract-card-name">${escapeHtml(c.name)}</div>
                        <span class="category-badge" style="margin-top:4px">${escapeHtml(c.category)}</span>
                    </div>
                    <div>
                        <span class="status-badge ${escapeHtml(c.status)}">${c.status === 'expired' ? 'Abgelaufen' : 'Gek\u00fcndigt'}</span>
                        ${statusExtra}
                    </div>
                </div>
                <div class="contract-card-details">
                    <span>Start: ${formatDate(c.start_date)}</span>
                    ${c.customer_number ? `<span>KdNr. ${escapeHtml(c.customer_number)}</span>` : ''}
                    ${c.contract_number ? `<span>VNr. ${escapeHtml(c.contract_number)}</span>` : ''}
                    <span><strong>${formatCost(c.monthly_cost)}</strong> / Monat${billingExtra}${splitExtra}</span>
                    <span>K\u00fcndigung: ${formatDate(c.cancellation_date)}</span>
                </div>
                <div class="contract-card-actions">
                    <button class="btn btn-sm btn-secondary" data-action="edit-contract" data-contract-id="${c.id}">${iconEdit()} Bearbeiten</button>
                    <button class="btn btn-sm btn-danger" data-action="delete-contract" data-contract-id="${c.id}" data-contract-name="${escapeHtml(c.name)}">${iconTrash()}</button>
                </div>
            </div>`;
        }

        // ============ MAIN RENDER ============
        function render() {
            let html = '';
            if (state.view === 'loading') html = renderLoading();
            else if (state.view === 'login') html = renderLogin();
            else if (state.view === 'dashboard') html = renderDashboard();
            app.innerHTML = html;
            afterRender();
        }

        function afterRender() {
            // Autofocus
            const nameInput = document.getElementById('contract-name-input');
            if (nameInput && state.modal && state.modal.type === 'contract-form') nameInput.focus();
            const pwInput = document.getElementById('pw-input');
            if (pwInput && state.passwordMode) pwInput.focus();
            // Auto-resize textareas
            document.querySelectorAll('textarea').forEach(autoResizeTextarea);
        }

        // ============ EVENT DELEGATION ============
        document.addEventListener('click', (e) => {
            const btn = e.target.closest('[data-action]');
            if (!btn) {
                // Check for modal overlay click
                if (e.target.closest('[data-stop-propagation]')) return;
                return;
            }
            const action = btn.dataset.action;

            switch (action) {
                case 'toggle-theme': cycleTheme(); break;
                case 'show-changelog': showModal('changelog'); break;
                case 'close-modal': closeModal(); break;
                case 'select-user': {
                    const name = btn.dataset.user;
                    const hasPw = btn.dataset.hasPassword === '1';
                    handleUserClick({ name, hasPassword: hasPw });
                    break;
                }
                case 'new-user': {
                    const input = document.getElementById('new-user-input');
                    if (input) handleNewUser(input.value);
                    break;
                }
                case 'password-back': handlePasswordBack(); break;
                case 'toggle-pw':
                    state.showPw = !state.showPw;
                    render();
                    break;
                case 'submit-password': submitPassword(); break;
                case 'logout': handleLogout(); break;
                case 'show-settings': showModal('settings'); break;
                case 'new-contract': showModal('contract-form', null); break;
                case 'edit-contract': {
                    const id = Number(btn.dataset.contractId);
                    const contract = state.contracts.find(c => c.id === id);
                    if (contract) showModal('contract-form', contract);
                    break;
                }
                case 'delete-contract': {
                    const id = Number(btn.dataset.contractId);
                    const name = btn.dataset.contractName;
                    showModal('delete-confirm', { id, name });
                    break;
                }
                case 'confirm-delete': handleDeleteContract(); break;
                case 'save-contract': break; // handled by form submit
                case 'sort': {
                    const field = btn.dataset.sortField;
                    state.sort = {
                        field,
                        dir: state.sort.field === field && state.sort.dir === 'asc' ? 'desc' : 'asc'
                    };
                    render();
                    break;
                }
                case 'toggle-expired':
                    state.showExpiredSection = !state.showExpiredSection;
                    render();
                    break;
                // Settings actions
                case 'export': {
                    const format = btn.dataset.format;
                    const sessionToken = localStorage.getItem('contracts_session') || '';
                    const url = `/api/export/${format}?session_token=${encodeURIComponent(sessionToken)}&api_key=${encodeURIComponent(API_KEY)}&t=${Date.now()}`;
                    const a = document.createElement('a');
                    a.href = url; a.style.display = 'none';
                    document.body.appendChild(a); a.click(); document.body.removeChild(a);
                    showToast(`${format.toUpperCase()}-Export gestartet`);
                    break;
                }
                case 'import': handleImport(); break;
                case 'new-group':
                    settingsState.editGroup = { name: '', color: '#4CAF50' };
                    render();
                    break;
                case 'edit-group': {
                    const id = Number(btn.dataset.groupId);
                    const name = btn.dataset.groupName;
                    const color = btn.dataset.groupColor;
                    settingsState.editGroup = { id, name, color };
                    render();
                    break;
                }
                case 'delete-group': {
                    const id = Number(btn.dataset.groupId);
                    deleteGroup(id).then(() => showToast('Gruppe gel\u00f6scht')).catch(e => showToast(e.message, 'error'));
                    break;
                }
                case 'save-group': {
                    if (!settingsState.editGroup || !settingsState.editGroup.name.trim()) return;
                    saveGroup(settingsState.editGroup).then(() => {
                        showToast(settingsState.editGroup.id ? 'Gruppe aktualisiert' : 'Gruppe erstellt');
                        settingsState.editGroup = null;
                        render();
                    }).catch(e => showToast(e.message, 'error'));
                    break;
                }
                case 'cancel-edit-group':
                    settingsState.editGroup = null;
                    render();
                    break;
                case 'confirm-delete-account':
                    settingsState.confirmDelete = true;
                    render();
                    break;
                case 'cancel-delete-account':
                    settingsState.confirmDelete = false;
                    render();
                    break;
                case 'delete-account':
                    handleDeleteAccount();
                    break;
            }
        });

        // Form submit
        document.addEventListener('submit', (e) => {
            if (e.target.id === 'contract-form') {
                e.preventDefault();
                handleSaveContract();
            }
        });

        // Input events for filters and form fields
        document.addEventListener('input', (e) => {
            const field = e.target.dataset.field;
            if (!field) return;

            // Filter fields
            if (field === 'filter-search') { state.filter.search = e.target.value; render(); return; }

            // Password fields
            if (field === 'pw') { _pwLocal = e.target.value; return; }
            if (field === 'pw2') { _pw2Local = e.target.value; return; }

            // Settings group fields
            if (field === 'group-name' && settingsState.editGroup) { settingsState.editGroup.name = e.target.value; return; }
            if (field === 'group-color' && settingsState.editGroup) { settingsState.editGroup.color = e.target.value; return; }

            // Contract form fields
            if (formState && field in formState) {
                formState[field] = e.target.value;
                // Auto-resize textareas
                if (e.target.tagName === 'TEXTAREA') autoResizeTextarea(e.target);
                // Re-render for preview updates on relevant fields
                if (['start_date', 'duration_months', 'cancellation_period_months', 'auto_renew', 'cancellation_date_override', 'cost', 'billing_interval'].includes(field)) {
                    // Update preview section only
                    const previewEl = document.querySelector('.calculated-preview');
                    const preview = calculatePreviewDates();
                    if (previewEl && preview) {
                        // Just re-render the whole modal for simplicity on structural changes
                        render();
                    }
                }
            }
        });

        // Change events for selects and checkboxes
        document.addEventListener('change', (e) => {
            const field = e.target.dataset.field;
            if (!field) return;

            // Filter selects
            if (field === 'filter-category') { state.filter.category = e.target.value; render(); return; }
            if (field === 'filter-group') { state.filter.group = e.target.value; render(); return; }
            if (field === 'filter-status') { state.filter.status = e.target.value; render(); return; }

            // Settings toggles
            if (field === 'showCategoryStats') {
                state.showCategoryStats = e.target.checked;
                localStorage.setItem('contracts_showCategoryStats', e.target.checked);
                showToast('Einstellung gespeichert');
                render();
                return;
            }
            if (field === 'showGroupStats') {
                state.showGroupStats = e.target.checked;
                localStorage.setItem('contracts_showGroupStats', e.target.checked);
                showToast('Einstellung gespeichert');
                render();
                return;
            }
            if (field === 'hideExpiredCancelled') {
                state.hideExpiredCancelled = e.target.checked;
                localStorage.setItem('contracts_hideExpiredCancelled', e.target.checked);
                showToast('Einstellung gespeichert');
                render();
                return;
            }

            // Settings group fields
            if (field === 'group-color' && settingsState.editGroup) { settingsState.editGroup.color = e.target.value; return; }

            // Contract form fields
            if (formState && field in formState) {
                if (e.target.type === 'checkbox') {
                    formState[field] = e.target.checked;
                } else if (field === 'group_id') {
                    formState[field] = e.target.value ? Number(e.target.value) : '';
                } else {
                    formState[field] = e.target.value;
                }
                // Status change: auto-set cancelled_at
                if (field === 'status' && e.target.value === 'cancelled' && !formState.cancelled_at) {
                    formState.cancelled_at = new Date().toISOString().split('T')[0];
                }
                // Re-render on structural changes
                if (['status', 'notify', 'auto_renew', 'billing_interval', 'cost', 'start_date', 'duration_months', 'cancellation_period_months', 'cancellation_date_override'].includes(field)) {
                    render();
                }
            }
        });

        // Keydown for Enter in input fields
        document.addEventListener('keydown', (e) => {
            if (e.key === 'Enter') {
                const field = e.target.dataset.field;
                if (field === 'pw' && state.passwordMode === 'login') { submitPassword(); return; }
                if (field === 'pw2') { submitPassword(); return; }
                if (e.target.id === 'new-user-input') { handleNewUser(e.target.value); return; }
            }
            if (e.key === 'Escape' && state.modal) {
                closeModal();
            }
        });

        async function submitPassword() {
            if (_pwBusy) return;
            if (!_pwLocal) { showToast('Bitte Passwort eingeben', 'error'); return; }
            if (_pwLocal.length < 4) { showToast('Passwort: mindestens 4 Zeichen', 'error'); return; }
            const needsConfirm = state.passwordMode === 'set-password' || state.passwordMode === 'register';
            if (needsConfirm && _pwLocal !== _pw2Local) { showToast('Passw\u00f6rter stimmen nicht \u00fcberein', 'error'); return; }
            _pwBusy = true;
            render();
            if (state.passwordMode === 'login') await handleLogin(_pwLocal);
            else if (state.passwordMode === 'set-password') await handleSetPassword(_pwLocal);
            else await handleRegister(_pwLocal);
            _pwBusy = false;
            _pwLocal = ''; _pw2Local = '';
        }

        async function handleImport() {
            const file = document.getElementById('import-file');
            if (!file || !file.files || !file.files[0]) { showToast('Bitte eine JSON-Datei ausw\u00e4hlen', 'error'); return; }
            settingsState.importing = true;
            render();
            try {
                const text = await file.files[0].text();
                const data = JSON.parse(text);
                if (!Array.isArray(data)) throw new Error('Datei muss ein Array von Vertr\u00e4gen enthalten');
                const r = await apiCall(`${API_BASE}/api/import/json`, { method: 'POST', body: JSON.stringify({ data }) });
                const result = await r.json();
                showToast(`${result.imported} Vertr\u00e4ge importiert`);
                closeModal();
                loadContracts();
            } catch (err) {
                showToast(err.message || 'Import fehlgeschlagen', 'error');
            } finally {
                settingsState.importing = false;
            }
        }

        async function handleDeleteAccount() {
            settingsState.deleting = true;
            render();
            try {
                await apiCall(`${API_BASE}/api/users/${encodeURIComponent(state.user)}`, { method: 'DELETE' });
                showToast('Account gel\u00f6scht');
                localStorage.removeItem('contracts_session');
                localStorage.removeItem('contracts_user');
                state.user = ''; state.userId = null; state.contracts = []; state.stats = null;
                state.view = 'login'; state.passwordMode = null; state.selectedUser = '';
                state.modal = null;
                await loadUsers();
                render();
            } catch (e) {
                showToast(e.message || 'Fehler beim L\u00f6schen', 'error');
                settingsState.confirmDelete = false;
                settingsState.deleting = false;
                render();
            }
        }

        // ============ ONLINE/OFFLINE ============
        window.addEventListener('offline', () => { state.isOnline = false; render(); });
        window.addEventListener('online', () => { state.isOnline = true; showToast('Wieder online'); render(); });

        // ============ INIT ============
        (async () => {
            render(); // Show loading
            // Fetch categories and version
            try { const r = await fetch(`${API_BASE}/api/categories`); state.categories = await r.json(); } catch (_) {}
            try { const r = await fetch(`${API_BASE}/api/version`); const d = await r.json(); state.version = d.version; } catch (_) {}

            // Auto-login
            const savedToken = localStorage.getItem('contracts_session');
            if (savedToken) {
                try {
                    const r = await apiCall(`${API_BASE}/api/auth/verify`, {
                        method: 'POST', body: JSON.stringify({ token: savedToken })
                    });
                    const data = await r.json();
                    if (data.success && data.user) {
                        localStorage.setItem('contracts_user', data.user);
                        state.user = data.user;
                        state.userId = data.userId;
                        state.view = 'dashboard';
                        render();
                        loadContracts();
                        loadGroups();
                        return;
                    }
                } catch (_) {}
                localStorage.removeItem('contracts_session');
            }
            await loadUsers();
            state.view = 'login';
            render();
        })();
    </script>
</body>
</html>
